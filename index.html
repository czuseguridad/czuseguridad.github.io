<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunaria Mining Premium - Registro e Inicio de Sesión</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="icon" href="https://i.postimg.cc/GpPsSmmX/4491470.png" type="image/png">
    <meta name="theme-color" content="#06b6d4">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { 
            --primary-bg: #0f172a; 
            --secondary-bg: #1e293b; 
            --card-bg: #334155; 
            --text-primary: #f1f5f9; 
            --text-secondary: #94a3b8; 
            --accent: #0ea5e9; 
            --accent-hover: #0284c7; 
            --success: #22c55e; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --border: #475569; 
            --shadow: rgba(0, 0, 0, 0.5); 
        }
        
        [data-theme="light"] { 
            --primary-bg: #f8fafc; 
            --secondary-bg: #f1f5f9; 
            --card-bg: #ffffff; 
            --text-primary: #1e293b; 
            --text-secondary: #64748b; 
            --accent: #0ea5e9; 
            --accent-hover: #0284c7; 
            --success: #22c55e; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --border: #e2e8f0; 
            --shadow: rgba(0, 0, 0, 0.1); 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%); 
            color: var(--text-primary); 
            transition: all 0.3s ease; 
            min-height: 100vh; 
            overflow-x: hidden; 
        }
        
        .login-container { 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 2rem; 
            position: relative; 
        }
        
        .background-animation { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            z-index: 0; 
        }
        
        .floating-shape { 
            position: absolute; 
            background: rgba(14, 165, 233, 0.1); 
            border-radius: 50%; 
            animation: float 6s ease-in-out infinite; 
        }
        
        .floating-shape:nth-child(1) { 
            width: 100px; 
            height: 100px; 
            top: 20%; 
            left: 10%; 
            animation-delay: 0s; 
        }
        
        .floating-shape:nth-child(2) { 
            width: 150px; 
            height: 150px; 
            top: 60%; 
            right: 15%; 
            animation-delay: 2s; 
        }
        
        .floating-shape:nth-child(3) { 
            width: 80px; 
            height: 80px; 
            bottom: 30%; 
            left: 15%; 
            animation-delay: 4s; 
        }
        
        @keyframes float { 
            0%, 100% { transform: translateY(0px) rotate(0deg); } 
            50% { transform: translateY(-20px) rotate(180deg); } 
        }
        
        .login-card { 
            background: var(--card-bg); 
            border-radius: 20px; 
            border: 1px solid var(--border); 
            box-shadow: 0 20px 60px var(--shadow); 
            padding: 3rem; 
            width: 100%; 
            max-width: 450px; 
            position: relative; 
            z-index: 1; 
            backdrop-filter: blur(10px); 
        }
        
        .logo-container { 
            text-align: center; 
            margin-bottom: 2rem; 
        }
        
        .logo { 
            width: 80px; 
            height: 80px; 
            margin: 0 auto 1rem; 
            border-radius: 50%; 
            border: 3px solid var(--accent); 
            padding: 10px; 
            background: rgba(14, 165, 233, 0.1); 
        }
        
        .form-input { 
            width: 100%; 
            padding: 1rem; 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            background: var(--primary-bg); 
            color: var(--text-primary); 
            font-size: 1.125rem; 
            transition: all 0.3s ease; 
        }
        
        .form-input:focus { 
            outline: none; 
            border-color: var(--accent); 
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); 
            transform: scale(1.02); 
        }
        
        .btn { 
            padding: 1rem 1.5rem; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem; 
            font-size: 0.875rem; 
            text-decoration: none; 
            position: relative; 
            overflow: hidden; 
            width: 100%; 
            margin-bottom: 0.75rem; 
        }
        
        .btn:hover:not(:disabled) { 
            transform: translateY(-2px); 
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary { 
            background: var(--accent); 
            color: white; 
        }
        
        .btn-primary:hover:not(:disabled) { 
            background: var(--accent-hover); 
        }
        
        .btn-secondary { 
            background: var(--secondary-bg); 
            color: var(--text-primary); 
            border: 1px solid var(--border); 
        }
        
        .error-message, .success-message, .info-message { 
            padding: 1rem; 
            border-radius: 8px; 
            margin-bottom: 1rem; 
            font-size: 0.875rem; 
            font-weight: 500; 
            display: none; 
            animation: slideIn 0.3s ease; 
        }
        
        .error-message { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--danger); 
            border: 1px solid var(--danger); 
        }
        
        .success-message { 
            background: rgba(34, 197, 94, 0.1); 
            color: var(--success); 
            border: 1px solid var(--success); 
        }
        
        .info-message { 
            background: rgba(14, 165, 233, 0.1); 
            color: var(--accent); 
            border: 1px solid var(--accent); 
        }
        
        @keyframes slideIn { 
            from { opacity: 0; transform: translateY(-10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .form-group { 
            margin-bottom: 1rem; 
        }
        
        .form-label { 
            font-size: 0.875rem; 
            font-weight: 600; 
            color: var(--text-secondary); 
            margin-bottom: 0.5rem; 
            display: block; 
        }
        
        .tab-button { 
            flex-grow: 1; 
            padding: 1rem; 
            border-radius: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            background: var(--secondary-bg); 
            color: var(--text-secondary); 
            border: 1px solid var(--border);
        }
        
        .tab-button.active { 
            background: var(--accent); 
            color: white; 
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .password-container {
            position: relative;
        }

        .password-toggle-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.125rem;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="background-animation">
            <div class="floating-shape"></div>
            <div class="floating-shape"></div>
            <div class="floating-shape"></div>
        </div>
        
        <div class="login-card">
            <div class="logo-container">
                <img src="https://i.postimg.cc/GpPsSmmX/4491470.png" alt="Lunaria Mining Premium" class="logo">
                <h1 class="text-2xl font-bold text-center mb-2">Lunaria Mining Premium</h1>
                <p class="text-sm text-center opacity-75">Sistema de Acceso</p>
            </div>
            
            <div id="errorMessage" class="error-message">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="errorText"></span>
            </div>
            
            <div id="successMessage" class="success-message">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="successText"></span>
            </div>
            
            <div id="infoMessage" class="info-message">
                <i class="fas fa-info-circle mr-2"></i>
                <span id="infoText"></span>
            </div>
            
            <div class="flex space-x-2 mb-6">
                <button id="tabLogin" class="tab-button active">Iniciar Sesión</button>
                <button id="tabRegister" class="tab-button">Registrarse</button>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail" class="form-label">
                        <i class="fas fa-envelope mr-2"></i>Correo Electrónico
                    </label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="tu_correo@ejemplo.com" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword" class="form-label">
                        <i class="fas fa-lock mr-2"></i>Contraseña
                    </label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" class="form-input" placeholder="***********" required>
                        <i class="password-toggle-icon fas fa-eye" onclick="togglePasswordVisibility('loginPassword')"></i>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="loginBtnText">Iniciar Sesión</span>
                </button>
            </form>

            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerFirstName" class="form-label">
                        <i class="fas fa-user mr-2"></i>Nombre
                    </label>
                    <input type="text" id="registerFirstName" class="form-input" placeholder="Tu nombre" required>
                </div>
                <div class="form-group">
                    <label for="registerLastName" class="form-label">
                        <i class="fas fa-user-tag mr-2"></i>Apellido
                    </label>
                    <input type="text" id="registerLastName" class="form-input" placeholder="Tu apellido" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail" class="form-label">
                        <i class="fas fa-envelope mr-2"></i>Correo Electrónico
                    </label>
                    <input type="email" id="registerEmail" class="form-input" placeholder="tu_correo@ejemplo.com" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword" class="form-label">
                        <i class="fas fa-lock mr-2"></i>Contraseña
                    </label>
                    <div class="password-container">
                        <input type="password" id="registerPassword" class="form-input" placeholder="***********" required minlength="6">
                        <i class="password-toggle-icon fas fa-eye" onclick="togglePasswordVisibility('registerPassword')"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword" class="form-label">
                        <i class="fas fa-lock mr-2"></i>Repetir Contraseña
                    </label>
                    <div class="password-container">
                        <input type="password" id="registerConfirmPassword" class="form-input" placeholder="***********" required minlength="6">
                        <i class="password-toggle-icon fas fa-eye" onclick="togglePasswordVisibility('registerConfirmPassword')"></i>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="registerBtn">
                    <i class="fas fa-user-plus"></i>
                    <span id="registerBtnText">Registrarse</span>
                </button>
            </form>
        </div>
    </div>

    <script>
        // *** CONFIGURACIÓN DE SUPABASE ***
        const SUPABASE_URL = 'https://pfiidibdkyxgerklpivy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmaWlkaWJka3l4Z2Vya2xwaXZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MTc5NjEsImV4cCI6MjA3MTQ5Mzk2MX0.mAwZnH2ZGhWH2b5Mml3HGLPc7qRckw13zNHFCOXcz7c';
        
        // URL de redirección después del login exitoso
        const REDIRECT_URL = './lunaria.html';

        // Inicializar cliente de Supabase
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Referencias a elementos del DOM
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const tabLogin = document.getElementById('tabLogin');
        const tabRegister = document.getElementById('tabRegister');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const loginBtnText = document.getElementById('loginBtnText');
        const registerBtnText = document.getElementById('registerBtnText');

        // Expresión regular para validar email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        // Inicialización cuando se carga el documento
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Página cargada');
            
            // Verificar sesión activa
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    showInfoMessage('Sesión activa detectada. Redirigiendo...');
                    setTimeout(() => redirectToMainApp(), 2000);
                    return;
                }
            } catch (error) {
                console.error('Error al verificar sesión:', error);
            }

            // Configurar event listeners para las pestañas
            setupTabListeners();
        });

        function setupTabListeners() {
            tabLogin.addEventListener('click', () => {
                showLoginForm();
            });

            tabRegister.addEventListener('click', () => {
                showRegisterForm();
            });
        }

        function showLoginForm() {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            tabLogin.classList.add('active');
            tabRegister.classList.remove('active');
            hideMessages();
        }

        function showRegisterForm() {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            tabLogin.classList.remove('active');
            tabRegister.classList.add('active');
            hideMessages();
        }

        // Manejar envío del formulario de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Intento de login');
            
            hideMessages();
            setLoading(loginBtn, loginBtnText, true, 'Iniciando...');

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            // Validación básica
            if (!validateEmail(email) || !validatePassword(password)) {
                setLoading(loginBtn, loginBtnText, false, 'Iniciar Sesión');
                return;
            }
            
            try {
                console.log('Intentando iniciar sesión con:', email);
                const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                    email, 
                    password 
                });
                
                if (error) {
                    throw error;
                }
                
                console.log('Login exitoso:', data);
                showSuccessMessage('¡Inicio de sesión exitoso!');
                setTimeout(() => redirectToMainApp(), 1500);
                
            } catch (error) {
                console.error('Error de inicio de sesión:', error);
                let errorMessage = 'Error al iniciar sesión';
                
                if (error.message) {
                    if (error.message.includes('Invalid login credentials')) {
                        errorMessage = 'Credenciales inválidas. Verifica tu email y contraseña.';
                    } else if (error.message.includes('Email not confirmed')) {
                        errorMessage = 'Por favor, confirma tu correo electrónico antes de iniciar sesión.';
                    } else {
                        errorMessage = `Error: ${error.message}`;
                    }
                }
                
                showErrorMessage(errorMessage);
            } finally {
                setLoading(loginBtn, loginBtnText, false, 'Iniciar Sesión');
            }
        });

        // Manejar envío del formulario de registro
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Intento de registro');
            
            hideMessages();
            setLoading(registerBtn, registerBtnText, true, 'Registrando...');

            const firstName = document.getElementById('registerFirstName').value.trim();
            const lastName = document.getElementById('registerLastName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();

            // Validaciones
            if (!firstName || !lastName) {
                showErrorMessage('Por favor, completa todos los campos.');
                setLoading(registerBtn, registerBtnText, false, 'Registrarse');
                return;
            }

            if (password !== confirmPassword) {
                showErrorMessage('Las contraseñas no coinciden.');
                setLoading(registerBtn, registerBtnText, false, 'Registrarse');
                return;
            }

            if (!validateEmail(email) || !validatePassword(password)) {
                setLoading(registerBtn, registerBtnText, false, 'Registrarse');
                return;
            }
            
            try {
                console.log('Intentando registrar usuario:', email);
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            first_name: firstName,
                            last_name: lastName,
                            full_name: `${firstName} ${lastName}`
                        },
                    },
                });
                
                if (error) {
                    throw error;
                }
                
                console.log('Registro exitoso:', data);
                
                if (data.user && !data.user.email_confirmed_at) {
                    showSuccessMessage('¡Registro exitoso! Por favor, verifica tu correo electrónico para confirmar tu cuenta antes de iniciar sesión.');
                } else {
                    showSuccessMessage('¡Registro exitoso! Ya puedes iniciar sesión.');
                }
                
                // Limpiar formulario
                document.getElementById('registerForm').reset();
                
                // Cambiar a pestaña de login después de 3 segundos
                setTimeout(() => {
                    showLoginForm();
                }, 3000);
                
            } catch (error) {
                console.error('Error de registro:', error);
                let errorMessage = 'Error de registro';
                
                if (error.message) {
                    if (error.message.includes('User already registered')) {
                        errorMessage = 'Este correo electrónico ya está registrado. Intenta iniciar sesión.';
                    } else if (error.message.includes('Password should be at least 6 characters')) {
                        errorMessage = 'La contraseña debe tener al menos 6 caracteres.';
                    } else {
                        errorMessage = `Error: ${error.message}`;
                    }
                }
                
                showErrorMessage(errorMessage);
            } finally {
                setLoading(registerBtn, registerBtnText, false, 'Registrarse');
            }
        });

        // Función para alternar la visibilidad de la contraseña
        function togglePasswordVisibility(inputId) {
            const passwordInput = document.getElementById(inputId);
            const icon = passwordInput.nextElementSibling;
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Función para validar email
        function validateEmail(email) {
            if (!email) {
                showErrorMessage('El correo electrónico es requerido.');
                return false;
            }
            if (!emailRegex.test(email)) {
                showErrorMessage('Por favor, ingresa un correo electrónico válido.');
                return false;
            }
            return true;
        }

        // Función para validar contraseña
        function validatePassword(password) {
            if (!password) {
                showErrorMessage('La contraseña es requerida.');
                return false;
            }
            if (password.length < 6) {
                showErrorMessage('La contraseña debe tener al menos 6 caracteres.');
                return false;
            }
            return true;
        }

        // Función para redirigir a la aplicación principal
        function redirectToMainApp() {
            console.log('Redirigiendo a:', REDIRECT_URL);
            window.location.href = REDIRECT_URL;
        }

        // Función para manejar estados de carga de botones
        function setLoading(btn, btnText, loading, text) {
            btn.disabled = loading;
            if (loading) {
                btnText.innerHTML = `<span class="loading-spinner"></span> ${text}`;
            } else {
                btnText.textContent = text;
            }
        }

        // Funciones para mostrar mensajes
        function showErrorMessage(message) {
            hideMessages();
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            console.error('Error:', message);
        }

        function showSuccessMessage(message) {
            hideMessages();
            document.getElementById('successText').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            console.log('Éxito:', message);
        }

        function showInfoMessage(message) {
            hideMessages();
            document.getElementById('infoText').textContent = message;
            document.getElementById('infoMessage').style.display = 'block';
            console.info('Info:', message);
        }

        function hideMessages() {
            const messages = ['errorMessage', 'successMessage', 'infoMessage'];
            messages.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }
    </script>
</body>
</html>
