<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunaria Mining Premium</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="#" id="manifest"> 
    <link rel="icon" href="https://i.postimg.cc/GpPsSmmX/4491470.png" type="image/png">
    <meta name="theme-color" content="#06b6d4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lunaria Mining Premium">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/GpPsSmmX/4491470.png">
    
    <!-- Incluir Supabase JS aquí -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --card-bg: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        [data-theme="light"] {
            --primary-bg: #f8fafc;
            --secondary-bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--primary-bg); color: var(--text-primary); transition: all 0.3s ease; min-height: 100vh; display: flex; flex-direction: column; }
        main { flex-grow: 1; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1rem; width: 100%; }
        .card { background: var(--card-bg); border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 10px 30px var(--shadow); transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px var(--shadow); }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; text-decoration: none; position: relative; overflow: hidden; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--card-bg); }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 0.5rem; font-size: 0.8rem; min-width: 35px; height: 35px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 2rem; width: 90vw; max-width: 500px; max-height: 90vh; overflow-y: auto; position: relative; }
        .fullscreen-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: var(--primary-bg); z-index: 2000; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; gap: 2rem; opacity: 0; visibility: hidden; transition: all 0.3s ease; padding: 1rem; overflow-y: auto; }
        .fullscreen-modal.active { opacity: 1; visibility: visible; }
        .form-input, .form-select { width: 100%; padding: 0.875rem 1rem; border: 2px solid var(--border); border-radius: 12px; background: var(--primary-bg); color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        .category-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .category-faucet { background: rgba(34, 197, 94, 0.2); color: var(--success); border: 1px solid var(--success); }
        .category-mining { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .category-staking { background: rgba(14, 165, 233, 0.2); color: var(--accent); border: 1px solid var(--accent); }
        .category-defi { background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid #a855f7; }
        .category-trading { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .category-shorlin { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
        .category-other { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); border: 1px solid var(--text-secondary); }
        .category-favorites { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; }
        .search-filter-bar { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border); }
        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; background: var(--accent); border: none; border-radius: 50%; cursor: pointer; font-size: 1.5rem; color: white; box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); z-index: 100; }
        .notification { position: fixed; top: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 12px; color: white; font-weight: 600; z-index: 5100; transform: translateX(120%); transition: transform 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--accent); }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .user-id-container { position: fixed; top: 1rem; right: 0; display: flex; align-items: center; z-index: 100; transform: translateX(calc(100% - 45px)); transition: transform 0.3s ease-in-out; }
        .user-id-container.active { transform: translateX(0); }
        .user-id-toggle-btn { background: var(--accent); color: white; border: none; border-top-left-radius: 12px; border-bottom-left-radius: 12px; width: 45px; height: 45px; font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .user-id-panel { background: var(--card-bg); border: 1px solid var(--border); border-top-right-radius: 12px; border-bottom-right-radius: 12px; padding: 0.5rem 1rem; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; }
        .user-id-panel span { font-weight: 600; color: var(--accent); order: 2; }
        .user-id-copy-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1rem; order: 1; }
        .card-image { width: 100%; height: 180px; object-fit: cover; }
        .card-top-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; z-index: 10; }
        .card-top-btn { background: rgba(0, 0, 0, 0.6); color: white; border-radius: 50%; width: 35px; height: 35px; cursor: pointer; font-size: 0.875rem; display: flex; justify-content: center; align-items: center; }
        .card-top-btn.is-favorite { color: #f59e0b; }
        .card-content { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .card-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-dot.active { background-color: var(--success); }
        .status-dot.attention { background-color: var(--warning); }
        .status-dot.inactive { background-color: var(--danger); }
        .card-actions { display: flex; gap: 0.5rem; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 1rem; }
        .card-footer { border-top: 1px solid var(--border); padding: 0.75rem 1.5rem; font-size: 0.75rem; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; }
        .chart-container { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 2rem; }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-secondary); }
        .empty-state i { font-size: 4rem; color: var(--accent); margin-bottom: 1rem; }
        .filter-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .filter-chip { padding: 0.5rem 1rem; border-radius: 20px; background: var(--secondary-bg); cursor: pointer; font-size: 0.875rem; }
        .filter-chip.active { background: var(--accent); color: white; }
        .menu-button { width: 180px; height: 180px; border-radius: 20px; border: none; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1rem; font-size: 1.1rem; font-weight: 600; }
        .menu-button.faucet-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .menu-button.add-button { background: var(--accent); color: white; }
        .menu-button.export-button { background: var(--success); color: white; }
        .menu-button.delete-button { background: var(--danger); color: white; }
        .menu-button.investment-button { background: linear-gradient(135deg, #FF6B6B 0%, #FFD166 100%); color: white; }
        .menu-button.url-add-button { background: linear-gradient(135deg, #53d395 0%, #30c39e 100%); color: white; }
        .menu-button.share-all-button { background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%); color: white; }
        .menu-button.games-menu-button { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
        .menu-button.theme-toggle-menu-button { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; }
        .menu-button.share-app-button, .menu-button.install-button { width: 100%; height: 100px; font-size: 1.2rem; flex-direction: row; gap: 1rem; grid-column: span 2; }
        .menu-button.share-app-button { background: linear-gradient(135deg, #FF6F61 0%, #DE483A 100%); color: white; }
        .menu-button.install-button { background: linear-gradient(135deg, #20BDFF 0%, #A5FECB 100%); color: white; }
        .faucet-logo { width: 120px; height: 80px; border-radius: 8px; object-fit: contain; }
        .close-menu-btn { position: absolute; top: 2rem; right: 2rem; background: var(--danger); color: white; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .import-log { background: var(--primary-bg); border-radius: 8px; padding: 1rem; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; margin-top: 1rem; }
        .share-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1500; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .share-modal.active { opacity: 1; visibility: visible; }
        .share-content { background: var(--card-bg); border-radius: 20px; padding: 2rem; max-width: 90vw; width: 500px; position: relative; }
        .share-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1.5rem; }
        .share-option { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1rem; border-radius: 12px; background: var(--secondary-bg); cursor: pointer; }
        .share-preview { display: flex; align-items: center; gap: 1rem; margin-top: 1rem; padding: 1rem; border-radius: 12px; background: var(--secondary-bg); }
        .share-preview img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tooltip { position: absolute; background: var(--secondary-bg); padding: 0.5rem; border-radius: 6px; font-size: 0.75rem; z-index: 100; pointer-events: none; opacity: 0; }
        .tooltip.visible { opacity: 1; }
    </style>
</head>
<body>
    <!-- Modals -->
    <div id="storagePermissionModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-blue-400"><i class="fas fa-folder-plus mr-2"></i>Permiso de Almacenamiento</h2>
            <p class="text-gray-300 mb-6">Para garantizar que tus datos est&eacute;n seguros y respaldados, necesitamos acceso a una carpeta donde guardar autom&aacute;ticamente tus entradas de miner&iacute;a.</p>
            <div class="flex gap-4 justify-center">
                <button class="btn btn-primary" onclick="requestStoragePermission()"><i class="fas fa-check"></i>Conceder Permiso</button>
                <button class="btn btn-secondary" onclick="continueWithoutPermission()"><i class="fas fa-times"></i>Continuar sin Permiso</button>
            </div>
        </div>
    </div>

    <div id="mainMenuModal" class="fullscreen-modal">
        <button class="close-menu-btn" onclick="closeMainMenu()"><i class="fas fa-times"></i></button>
        <h2 class="text-3xl font-bold mb-8 text-center"><i class="fas fa-ellipsis-h mr-2"></i>Men&uacute; Principal</h2>
        <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-8">
            <button class="menu-button faucet-button" onclick="openExternalUrl('https://faucetpay.io/'); closeMainMenu();"><img src="https://i.postimg.cc/xd3HS5CW/Picsart-25-07-12-19-07-45-544.png" alt="FaucetPay" class="faucet-logo"><span>FaucetPay</span></button>
            <button class="menu-button investment-button" onclick="window.location.href='invercion.html'; closeMainMenu();"><i class="fas fa-money-bill-wave" style="font-size: 3rem;"></i><span>Inversi&oacute;n</span></button>
            <button class="menu-button url-add-button" onclick="openAddUrlModal(); closeMainMenu()"><i class="fas fa-code" style="font-size: 3rem;"></i><span>Integrar Tarjeta</span></button>
            <button class="menu-button share-all-button" onclick="shareAllEntriesAsCollection(); closeMainMenu();"><i class="fas fa-file-export" style="font-size: 3rem;"></i><span>Compartir Todo</span></button>
            <button class="menu-button add-button" onclick="openAddModal(); closeMainMenu()"><i class="fas fa-plus" style="font-size: 3rem;"></i><span>Agregar P&aacute;gina</span></button>
            <button class="menu-button export-button" onclick="openExportModal(); closeMainMenu()"><i class="fas fa-download" style="font-size: 3rem;"></i><span>Exportar/Importar</span></button>
            <button class="menu-button delete-button" onclick="showDeleteConfirmation(null, true); closeMainMenu();"><i class="fas fa-trash-alt" style="font-size: 3rem;"></i><span>Borrar Todo</span></button>
            <button class="menu-button theme-toggle-menu-button" onclick="toggleTheme(); closeMainMenu();"><i id="themeIconMenu" class="fas fa-moon" style="font-size: 3rem;"></i><span>Cambiar Tema</span></button>
            <button class="menu-button games-menu-button" onclick="window.location.href='juegosluminaria.html'; closeMainMenu();"><i class="fas fa-gamepad" style="font-size: 3rem;"></i><span>Tus Juegos</span></button>
            <button class="menu-button share-app-button" onclick="shareApp()"><i class="fas fa-share-square" style="font-size: 3rem;"></i><span>Compartir App</span></button>
            <button id="installAppButton" class="menu-button install-button" onclick="installApp()" style="display: none;"><i class="fas fa-download" style="font-size: 3rem;"></i><span>Instalar App</span></button>
            <button class="menu-button delete-button" onclick="signOutUser(); closeMainMenu();"><i class="fas fa-sign-out-alt" style="font-size: 3rem;"></i><span>Cerrar Sesi&oacute;n</span></button>
        </div>
    </div>

    <div id="updateNotification" class="update-notification">
        <h3 id="updateNotificationTitle"></h3>
        <p id="updateNotificationDescription"></p>
        <button class="btn btn-primary" onclick="closeUpdateNotification()">&iexcl;Entendido!</button>
    </div>

    <!-- UI Elements -->
    <div id="userIdContainer" class="user-id-container">
        <button id="userIdToggleButton" class="user-id-toggle-btn" aria-label="Toggle User ID"><i class="fas fa-angle-left"></i></button>
        <div id="userIdDisplay" class="user-id-panel">
            <button class="user-id-copy-btn" onclick="copyUserIdToClipboard()" data-tooltip="Copiar ID de Usuario"><i class="fas fa-copy"></i></button>
            ID de Usuario: <span id="currentUserId"></span>
        </div>
    </div>

    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-8">
        <div class="container text-center">
            <div class="flex justify-center items-center gap-4 mb-4">
                <img src="https://i.postimg.cc/GpPsSmmX/4491470.png" alt="Logo" class="w-16 h-16">
                <h1 class="text-5xl font-bold">Lunaria Mining Premium</h1>
            </div>
            <p class="text-xl opacity-90">Gesti&oacute;n avanzada de entradas de miner&iacute;a con estad&iacute;sticas y categor&iacute;as</p>
        </div>
    </header>

    <section class="py-8">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="totalEntries">0</div><div class="stat-label">Total Entradas</div></div>
                <div class="stat-card"><div class="stat-value" id="totalCategories">0</div><div class="stat-label">Categor&iacute;as</div></div>
                <div class="stat-card"><div class="stat-value" id="favoriteEntries">0</div><div class="stat-label">Favoritas</div></div>
                <div class="stat-card"><div class="stat-value" id="totalClicks">0</div><div class="stat-label">Clicks Totales</div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="chart-container"><h3 class="text-xl font-bold mb-4">P&aacute;ginas M&aacute;s Usadas</h3><div style="height: 300px;"><canvas id="pageUsageChart"></canvas></div></div>
                <div class="chart-container"><h3 class="text-xl font-bold mb-4">Categor&iacute;as M&aacute;s Usadas</h3><div style="height: 300px;"><canvas id="categoryUsageChart"></canvas></div></div>
            </div>
        </div>
    </section>

    <section class="py-4">
        <div class="container">
            <div class="search-filter-bar">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div><label class="block text-sm font-medium mb-2">Buscar</label><div class="relative"><i class="fas fa-search absolute left-3 top-3 text-gray-400"></i><input type="text" id="searchInput" class="form-input pl-10" placeholder="Buscar entradas..."></div></div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Categor&iacute;a</label>
                        <select id="categoryFilter" class="form-select">
                            <option value="">Todas las categor&iacute;as</option>
                            <option value="favorites">Favoritos</option>
                            <option value="faucet">Faucets</option>
                            <option value="mining">Mining</option>
                            <option value="staking">Staking</option>
                            <option value="defi">DeFi</option>
                            <option value="trading">Trading</option>
                            <option value="shorlin">Shorlin Fause</option>
                            <option value="other">Otros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Ordenar por</label>
                        <select id="sortBy" class="form-select">
                            <option value="newest">M&aacute;s recientes</option>
                            <option value="oldest">M&aacute;s antiguos</option>
                            <option value="favorites">Favoritos primero</option>
                            <option value="mostClicked">M&aacute;s clickeados</option>
                            <option value="name">Nombre A-Z</option>
                            <option value="category">Categor&iacute;a</option>
                        </select>
                    </div>
                </div>
                <div class="filter-chips">
                    <div class="filter-chip active" data-category="">Todas</div>
                    <div class="filter-chip" data-category="favorites"><i class="fas fa-star"></i> Favoritos</div>
                    <div class="filter-chip" data-category="faucet"><i class="fas fa-tint"></i> Faucets</div>
                    <div class="filter-chip" data-category="mining"><i class="fas fa-pickaxe"></i> Mining</div>
                    <div class="filter-chip" data-category="staking"><i class="fas fa-coins"></i> Staking</div>
                    <div class="filter-chip" data-category="defi"><i class="fas fa-chart-line"></i> DeFi</div>
                    <div class="filter-chip" data-category="trading"><i class="fas fa-exchange-alt"></i> Trading</div>
                    <div class="filter-chip" data-category="shorlin"><i class="fas fa-briefcase"></i> Shorlin Fause</div>
                    <div class="filter-chip" data-category="other"><i class="fas fa-ellipsis-h"></i> Otros</div>
                </div>
            </div>
        </div>
    </section>

    <main class="py-8">
        <div class="container">
            <div id="emptyState" class="empty-state"><i class="fas fa-gem"></i><h3 class="text-2xl font-bold mb-2">No hay entradas de miner&iacute;a</h3><p class="mb-4">Comienza agregando tu primera entrada</p><button class="btn btn-primary" onclick="openAddModal()">Agregar Primera Entrada</button></div>
            <div id="cardsGrid" class="cards-grid"></div>
        </div>
    </main>

    <button class="fab" onclick="openMainMenu()" aria-label="Menú principal"><i class="fas fa-ellipsis-h"></i></button>
    <div id="tooltip" class="tooltip"></div>

    <!-- More Modals -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-blue-400"><i class="fas fa-plus mr-2"></i><span id="modalTitle"></span></h2><button class="text-gray-400 hover:text-white text-2xl" onclick="closeAddModal()"><i class="fas fa-times"></i></button></div>
            <form id="miningForm" class="space-y-6">
                <div><label class="block text-sm font-medium mb-2">Imagen de Portada</label><div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer" onclick="document.getElementById('imageInput').click()"><img id="imagePreview" class="w-full max-w-sm h-48 object-cover rounded-lg mx-auto mb-4" src="https://i.postimg.cc/GpPsSmmX/4491470.png" alt="Previsualización"><p class="text-gray-400"><i class="fas fa-upload mr-2"></i>Hacer clic para cambiar imagen</p></div><input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(event)"></div>
                <div><label class="block text-sm font-medium mb-2">Nombre *</label><input type="text" id="nameInput" class="form-input" required><div id="nameError" class="text-red-500 text-sm mt-1"></div></div>
                <div><label class="block text-sm font-medium mb-2">Categor&iacute;a *</label><select id="categoryInput" class="form-select" required><option value="">Seleccionar</option><option value="faucet">Faucets</option><option value="mining">Mining</option><option value="staking">Staking</option><option value="defi">DeFi</option><option value="trading">Trading</option><option value="shorlin">Shorlin Fause</option><option value="other">Otros</option></select><div id="categoryError" class="text-red-500 text-sm mt-1"></div></div>
                <div><label class="block text-sm font-medium mb-2">URL</label><input type="url" id="urlInput" class="form-input"><div id="urlError" class="text-red-500 text-sm mt-1"></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium mb-2">Estado</label><select id="statusInput" class="form-select"><option value="active">Activo</option><option value="attention">Requiere Atenci&oacute;n</option><option value="inactive">Inactivo</option></select></div>
                    <div><label class="block text-sm font-medium mb-2">Color de Tarjeta</label><input type="color" id="cardColorInput" class="form-input h-12 p-1" value="#0ea5e9"></div>
                </div>
                <div><label class="block text-sm font-medium mb-2">Descripci&oacute;n</label><textarea id="descriptionInput" class="form-input" rows="3"></textarea></div>
                <div><label class="block text-sm font-medium mb-2">Etiquetas (separadas por comas)</label><input type="text" id="tagsInput" class="form-input"></div>
                <div class="flex gap-4 justify-end"><button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancelar</button><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i><span id="saveButtonText"></span></button></div>
            </form>
        </div>
    </div>

    <div id="addUrlModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-green-400"><i class="fas fa-code mr-2"></i>Integrar Tarjeta o Colecci&oacute;n</h2><button class="text-gray-400 hover:text-white text-2xl" onclick="closeAddUrlModal()"><i class="fas fa-times"></i></button></div>
            <form id="addUrlForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Pegar C&oacute;digo *</label>
                    <input type="text" id="shareCodeInput" class="form-input" placeholder="C&oacute;digo de 10 d&iacute;gitos" maxlength="10" pattern="\d{10}" required>
                    <div id="shareCodeInputError" class="text-red-500 text-sm mt-1"></div>
                    <p class="text-gray-400 text-sm mt-2">Pega aqu&iacute; el c&oacute;digo de una tarjeta o de una colecci&oacute;n completa.</p>
                </div>
                <div class="flex gap-4 justify-end">
                    <button type="button" class="btn btn-secondary" onclick="closeAddUrlModal()">Cancelar</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-plus"></i>Integrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-red-400 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Confirmar Acci&oacute;n</h2>
            <p id="confirmMessage" class="mb-6 text-lg"></p>
            <div class="flex gap-4 justify-end">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancelar</button>
                <button id="confirmActionButton" class="btn btn-danger" onclick="confirmAction()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="share-modal">
        <div class="share-content">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-green-400"><i class="fas fa-share-alt mr-2"></i>Compartir</h2><button class="text-gray-400 hover:text-white text-2xl" onclick="closeShareModal()"><i class="fas fa-times"></i></button></div>
            <div id="sharePreview" class="share-preview"><img id="shareImage" src="" alt="Vista previa"><div><h3 id="shareName" class="font-bold"></h3><p id="shareCategory" class="text-sm text-gray-400"></p></div></div>
            <div class="mt-4 p-3 bg-gray-800 rounded-lg text-center">
                <p class="text-sm text-gray-400 mb-2">C&oacute;digo de Compartir:</p>
                <p id="displayShareCode" class="text-3xl font-bold text-blue-400 tracking-widest"></p>
            </div>
            <div class="share-options">
                <div class="share-option" onclick="copyShareCode()"><i class="fas fa-copy"></i><span>Copiar</span></div>
                <div class="share-option" onclick="shareCodeViaApp('WhatsApp')"><i class="fab fa-whatsapp"></i><span>WhatsApp</span></div>
                <div class="share-option" onclick="shareCodeViaApp('Telegram')"><i class="fab fa-telegram"></i><span>Telegram</span></div>
                <div class="share-option" onclick="shareCodeViaApp('Messenger')"><i class="fab fa-facebook-messenger"></i><span>Messenger</span></div>
                <div class="share-option" onclick="shareCodeViaApp('Email')"><i class="fas fa-envelope"></i><span>Email</span></div>
                <div class="share-option" onclick="shareCodeViaApp('Web Share')"><i class="fas fa-share-alt"></i><span>M&aacute;s</span></div>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-blue-400"><i class="fas fa-download mr-2"></i>Exportar/Importar</h2><button class="text-gray-400 hover:text-white text-2xl" onclick="closeExportModal()"><i class="fas fa-times"></i></button></div>
            <div class="space-y-6">
                <div><h3 class="text-lg font-semibold mb-4">Exportar Datos</h3><div class="flex gap-4"><button class="btn btn-primary" onclick="exportData('json')">JSON</button><button class="btn btn-secondary" onclick="exportData('csv')">CSV</button></div></div>
                <div><h3 class="text-lg font-semibold mb-4">Importar Datos</h3><input type="file" id="importFile" accept=".json,.csv" class="form-input mb-4"><button class="btn btn-success" onclick="importData()">Importar</button><div id="importLog" class="import-log mt-4"></div></div>
            </div>
        </div>
    </div>
    
    <script>
        // *** CONFIGURACIÓN DE SUPABASE ***
        const SUPABASE_URL = 'https://pfiidibdkyxgerklpivy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmaWlkaWJka3l4Z2Vya2xwaXZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MTc5NjEsImV4cCI6MjA3MTQ5Mzk2MX0.mAwZnH2ZGhWH2b5Mml3HGLPc7qRckw13zNHFCOXcz7c';
        const REDIRECT_LOGIN_URL = './auth.html';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let editingEntry = null, confirmCallback = null, pageUsageChart = null, categoryUsageChart = null, currentShareEntry = null;
        let directoryHandle = null, storagePermissionGranted = false, deferredPrompt = null;
        let currentUserId = null, currentUserEmail = null, isUserIdPanelActive = false, collectionShareCode = null;
        
        const appUpdates = [
            { id: 'v1.8.2', title: '&iexcl;Correcci&oacute;n de Caracteres!', description: 'Hemos solucionado un problema de codificaci&oacute;n que causaba que las tildes y otros s&iacute;mbolos no se mostraran correctamente. &iexcl;Ahora todo el texto deber&iacute;a verse perfecto!' }
        ];

        const categories = {
            faucet: { name: 'Faucets', icon: 'fas fa-tint' }, mining: { name: 'Mining', icon: 'fas fa-pickaxe' },
            staking: { name: 'Staking', icon: 'fas fa-coins' }, defi: { name: 'DeFi', icon: 'fas fa-chart-line' },
            trading: { name: 'Trading', icon: 'fas fa-exchange-alt' }, shorlin: { name: 'Shorlin Fause', icon: 'fas fa-briefcase' },
            other: { name: 'Otros', icon: 'fas fa-ellipsis-h' }, favorites: { name: 'Favoritos', icon: 'fas fa-star' }
        };

        const barColors = ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)'];

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                showNotification("No has iniciado sesi&oacute;n. Redirigiendo...", 'warning', true);
                return setTimeout(() => window.location.href = REDIRECT_LOGIN_URL, 2000);
            }
            currentUserId = session.user.id; 
            currentUserEmail = session.user.email;
            showNotification(`&iexcl;Bienvenido, ${currentUserEmail}!`, 'success');
            
            await Promise.all([loadOrCreateUserId(), loadOrCreateCollectionShareCode(), loadEntries()]);
            setupEventListeners();
            updateStats();
            updateUsageCharts();
            loadTheme();
            checkStoragePermission();
            checkAppUpdates();
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installButton = document.getElementById('installAppButton');
                if (installButton) installButton.style.display = 'flex';
            });
        }

        async function checkAppUpdates() {
            const lastSeenUpdateId = localStorage.getItem('lastSeenAppUpdateId');
            const latestUpdate = appUpdates[appUpdates.length - 1];
            if (latestUpdate && latestUpdate.id !== lastSeenUpdateId) {
                document.getElementById('updateNotificationTitle').innerHTML = `<i class="fas fa-sparkles mr-2"></i> ${latestUpdate.title}`;
                document.getElementById('updateNotificationDescription').innerHTML = latestUpdate.description;
                document.getElementById('updateNotification').classList.add('active');
                localStorage.setItem('lastSeenAppUpdateId', latestUpdate.id);
            }
        }
        function closeUpdateNotification() { document.getElementById('updateNotification').classList.remove('active'); }

        async function openShareModal(id) {
            try {
                const { data: entry, error } = await supabaseClient.from('entries').select('*').eq('id', id).single();
                if (error || !entry) return showNotification('Entrada no encontrada.', 'error');
                if (!entry.share_code) {
                    entry.share_code = await generateUniqueShareCode();
                    await saveEntry(entry);
                }
                currentShareEntry = entry;
                document.getElementById('shareImage').src = entry.image;
                document.getElementById('shareName').textContent = entry.name;
                document.getElementById('shareCategory').textContent = `Categor&iacute;a: ${categories[entry.category]?.name || 'Otra'}`;
                document.getElementById('displayShareCode').textContent = entry.share_code;
                document.getElementById('shareModal').classList.add('active');
            } catch (error) { showNotification('Error al preparar para compartir', 'error'); }
        }
        function closeShareModal() { document.getElementById('shareModal').classList.remove('active'); }

        function copyShareCode() {
            if (!currentShareEntry?.share_code) return;
            navigator.clipboard.writeText(currentShareEntry.share_code).then(() => {
                showNotification('C&oacute;digo copiado', 'success');
                closeShareModal();
            });
        }

        async function shareAllEntriesAsCollection() { 
            try {
                if (!collectionShareCode) await loadOrCreateCollectionShareCode();
                if (!collectionShareCode) return showNotification('No se pudo generar c&oacute;digo de colecci&oacute;n.', 'error');
                currentShareEntry = { id: 'collection', name: 'Toda mi colecci&oacute;n', category: 'Colecci&oacute;n', image: 'https://i.postimg.cc/GpPsSmmX/4491470.png', share_code: collectionShareCode };
                document.getElementById('shareImage').src = currentShareEntry.image;
                document.getElementById('shareName').textContent = currentShareEntry.name;
                document.getElementById('shareCategory').textContent = currentShareEntry.category;
                document.getElementById('displayShareCode').textContent = currentShareEntry.share_code;
                document.getElementById('shareModal').classList.add('active');
            } catch (error) { showNotification('Error al compartir la colecci&oacute;n.', 'error'); }
        }
        
        async function saveEntry(entryData) {
            if (!currentUserId) throw new Error('ID de usuario no disponible.');
            const formatted = { user_id: currentUserId, name: entryData.name, category: entryData.category, url: entryData.url, description: entryData.description, tags: entryData.tags, image: entryData.image, is_favorite: entryData.isFavorite, click_count: entryData.clickCount, last_opened: entryData.lastOpened, status: entryData.status, card_color: entryData.cardColor, share_code: entryData.shareCode };
            const query = entryData.id ? supabaseClient.from('entries').update(formatted).eq('id', entryData.id) : supabaseClient.from('entries').insert(formatted);
            const { data, error } = await query.select().single();
            if (error) throw error;
            return data;
        }

        async function getEntries() {
            if (!currentUserId) return [];
            const { data, error } = await supabaseClient.from('entries').select('*').eq('user_id', currentUserId);
            if (error) throw error;
            return data.map(entry => ({...entry, isFavorite: entry.is_favorite, clickCount: entry.click_count, lastOpened: entry.last_opened, cardColor: entry.card_color, shareCode: entry.share_code }));
        }
        async function getEntryById(id) {
            if (!currentUserId) return null;
            const { data, error } = await supabaseClient.from('entries').select('*').eq('id', id).eq('user_id', currentUserId).single();
            if (error) return null;
            return {...data, isFavorite: data.is_favorite, clickCount: data.click_count, lastOpened: data.last_opened, cardColor: data.card_color, shareCode: data.share_code };
        }
        async function deleteEntry(id) {
            if (!currentUserId) throw new Error('ID de usuario no disponible.');
            const { error } = await supabaseClient.from('entries').delete().eq('id', id).eq('user_id', currentUserId);
            if (error) throw error;
        }

        function getCanonicalUrl(rawUrl) {
            if (!rawUrl) return '';
            try {
                const url = new URL(rawUrl);
                let path = url.pathname.replace(/\/(\d+|[a-f0-9]{24,})$/, '');
                return url.origin + path;
            } catch (e) { return rawUrl; }
        }

        async function findEntryByNameAndUrl(name, rawUrl) {
            if (!currentUserId) return null;
            const canonicalUrl = getCanonicalUrl(rawUrl);
            const { data, error } = await supabaseClient.from('entries').select('*').eq('user_id', currentUserId).eq('name', name);
            if (error) throw error;
            return data.find(entry => getCanonicalUrl(entry.url) === canonicalUrl) || null;
        }

        async function findEntryByShareCode(code) {
            if (!code) return null;
            const { data, error } = await supabaseClient.rpc('rpc_get_shared_entry_by_code', { p_share_code: code });
            if (error) throw error;
            const entry = data?.[0];
            return entry ? { ...entry, isFavorite: entry.is_favorite, clickCount: entry.click_count, lastOpened: entry.last_opened, cardColor: entry.card_color, shareCode: entry.share_code } : null;
        }

        async function generateUniqueShareCode() {
            for (let i = 0; i < 10; i++) {
                const code = Math.floor(1000000000 + Math.random() * 9000000000).toString();
                const { error } = await supabaseClient.from('entries').select('share_code').eq('share_code', code).single();
                if (error && error.code === 'PGRST116') return code;
            }
            throw new Error("No se pudo generar un c&oacute;digo &uacute;nico.");
        }

        async function loadOrCreateUserId() {
            if (!currentUserId) return;
            document.getElementById('currentUserId').textContent = currentUserId.substring(0, 8);
            document.getElementById('userIdContainer').style.display = 'flex';
        }
        async function loadOrCreateCollectionShareCode() {
            if (!currentUserId) return;
            let code = await getUserSetting('collectionShareCode');
            if (!code) {
                code = await generateUniqueShareCode();
                await setUserSetting('collectionShareCode', code);
            }
            collectionShareCode = code;
        }

        async function loadEntries() {
            try {
                renderEntries(filterEntries(await getEntries()));
            } catch (error) { showNotification('Error al cargar las entradas', 'error'); }
        }

        function filterEntries(entries) {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            let filtered = entries.filter(e => (e.name.toLowerCase().includes(term)) && (category === 'favorites' ? e.isFavorite : !category || e.category === category));
            switch (sortBy) {
                case 'newest': return filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                case 'oldest': return filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                case 'name': return filtered.sort((a, b) => a.name.localeCompare(b.name));
                case 'favorites': return filtered.sort((a, b) => b.isFavorite - a.isFavorite);
                case 'mostClicked': return filtered.sort((a, b) => (b.clickCount || 0) - (a.clickCount || 0));
                default: return filtered;
            }
        }

        function renderEntries(entries) {
            const grid = document.getElementById('cardsGrid');
            const emptyState = document.getElementById('emptyState');
            emptyState.style.display = entries.length === 0 ? 'block' : 'none';
            grid.style.display = entries.length === 0 ? 'none' : 'grid';
            grid.innerHTML = entries.map(createCardHTML).join('');
        }

        function createCardHTML(entry) {
            const categoryInfo = categories[entry.category] || categories.other;
            const lastOpened = entry.lastOpened ? new Date(entry.lastOpened).toLocaleDateString() : 'Nunca';
            return `<div class="card" style="border-left: 5px solid ${entry.cardColor || '#0ea5e9'};">
                <img src="${entry.image}" alt="${escapeHtml(entry.name)}" class="card-image">
                <div class="card-top-actions">
                    <button class="card-top-btn ${entry.isFavorite ? 'is-favorite' : ''}" onclick="toggleFavorite('${entry.id}')" data-tooltip="Favorito"><i class="fas fa-star"></i></button>
                    <button class="card-top-btn" onclick="openShareModal('${entry.id}')" data-tooltip="Compartir"><i class="fas fa-share-alt"></i></button>
                </div>
                <div class="card-content">
                    <h3 class="card-title"><span class="status-dot ${entry.status || 'active'}"></span>${escapeHtml(entry.name)}</h3>
                    <div class="category-badge"><i class="${categoryInfo.icon} mr-2"></i>${categoryInfo.name}</div>
                    <div class="card-actions mt-4">
                        <button class="btn btn-primary flex-1" onclick="openMiningPage('${entry.id}')">Abrir</button>
                        <button class="btn btn-secondary btn-small" onclick="editEntry('${entry.id}')" data-tooltip="Editar"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-small" onclick="showDeleteConfirmation('${entry.id}')" data-tooltip="Eliminar"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="card-footer"><span>Abierto: ${lastOpened}</span><span>Clicks: ${entry.clickCount || 0}</span></div>
            </div>`;
        }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        
        function openAddModal() {
            editingEntry = null;
            document.getElementById('modalTitle').textContent = 'Agregar Entrada';
            document.getElementById('saveButtonText').textContent = 'Guardar';
            document.getElementById('miningForm').reset();
            document.getElementById('imagePreview').src = 'https://i.postimg.cc/GpPsSmmX/4491470.png';
            document.getElementById('cardColorInput').value = '#0ea5e9';
            clearErrors();
            document.getElementById('addModal').classList.add('active');
        }
        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); }

        function openAddUrlModal() {
            document.getElementById('addUrlForm').reset();
            clearErrors();
            document.getElementById('addUrlModal').classList.add('active');
        }
        function closeAddUrlModal() { document.getElementById('addUrlModal').classList.remove('active'); }

        document.getElementById('addUrlForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const shareCode = document.getElementById('shareCodeInput').value.trim();
            const errorDisplay = document.getElementById('shareCodeInputError');
            if (!/^\d{10}$/.test(shareCode)) { return errorDisplay.textContent = 'El c&oacute;digo debe ser num&eacute;rico de 10 d&iacute;gitos.'; }
            try {
                showNotification('Buscando...', 'info');
                const singleEntry = await findEntryByShareCode(shareCode);
                if (singleEntry) {
                    const result = await integrateSingleCard(singleEntry);
                    showNotification(result === 'added' ? 'Tarjeta integrada' : 'Ya tienes esta tarjeta', 'success');
                } else {
                    const { data: collection, error } = await supabaseClient.rpc('get_shared_collection_by_code', { p_collection_code: shareCode });
                    if (error) throw error;
                    if (collection?.length > 0) {
                        let added = 0, duplicates = 0;
                        for (const entry of collection) { (await integrateSingleCard(entry) === 'added') ? added++ : duplicates++; }
                        showNotification(`Colecci&oacute;n importada: ${added} a&ntilde;adidas, ${duplicates} omitidas.`, 'success');
                    } else {
                        showNotification('C&oacute;digo no v&aacute;lido.', 'warning');
                    }
                }
                await loadEntries(); updateStats(); updateUsageCharts(); closeAddUrlModal();
            } catch (error) { errorDisplay.textContent = `Error: ${error.message}.`; }
        });

        async function integrateSingleCard(cardData) {
            if (!currentUserId || !cardData.name || !categories[cardData.category]) return 'error';
            if (await findEntryByNameAndUrl(cardData.name, cardData.url)) return 'duplicate';
            const newEntry = { name: cardData.name, category: cardData.category, url: cardData.url, description: cardData.description || '', tags: cardData.tags || [], image: cardData.image || 'https://i.postimg.cc/GpPsSmmX/4491470.png', isFavorite: false, clickCount: 0, lastOpened: null, status: cardData.status || 'active', cardColor: cardData.cardColor || '#0ea5e9', shareCode: await generateUniqueShareCode() };
            await saveEntry(newEntry);
            return 'added';
        }

        async function editEntry(id) {
            const entry = await getEntryById(id);
            if (!entry) return;
            editingEntry = entry;
            document.getElementById('modalTitle').textContent = 'Editar Entrada';
            document.getElementById('saveButtonText').textContent = 'Actualizar';
            Object.keys(entry).forEach(key => {
                const input = document.getElementById(key + 'Input');
                if (input) input.value = key === 'tags' ? entry[key].join(', ') : entry[key];
            });
            document.getElementById('imagePreview').src = entry.image;
            document.getElementById('addModal').classList.add('active');
        }

        function showDeleteConfirmation(id, all = false) {
            confirmCallback = () => all ? performDeleteAll() : performDelete(id);
            document.getElementById('confirmMessage').textContent = `&iquest;Est&aacute;s seguro de que quieres borrar ${all ? 'TODAS tus entradas' : 'esta entrada'}?`;
            document.getElementById('confirmModal').classList.add('active');
        }
        function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('active'); }
        function confirmAction() { if (confirmCallback) confirmCallback(); }

        async function performDelete(id) {
            try { await deleteEntry(id); showNotification('Entrada eliminada', 'success'); await loadEntries(); updateStats(); } catch (e) { showNotification('Error al eliminar', 'error'); }
            finally { closeConfirmModal(); }
        }
        async function performDeleteAll() {
            try { await supabaseClient.from('entries').delete().eq('user_id', currentUserId); await loadEntries(); updateStats(); showNotification('Todas las entradas borradas', 'success'); } catch (e) { showNotification('Error al borrar todo', 'error'); }
            finally { closeConfirmModal(); }
        }

        document.getElementById('miningForm').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('nameInput').value.trim();
            const url = document.getElementById('urlInput').value.trim();
            if (!validateForm(name, document.getElementById('categoryInput').value, url)) return;
            try {
                if (!editingEntry && await findEntryByNameAndUrl(name, url)) return showNotification('Ya existe una entrada con ese nombre y URL.', 'warning');
                const entry = { id: editingEntry?.id, name, url, category: document.getElementById('categoryInput').value, description: document.getElementById('descriptionInput').value.trim(), tags: document.getElementById('tagsInput').value.trim().split(',').map(t => t.trim()).filter(Boolean), image: document.getElementById('imagePreview').src, isFavorite: editingEntry?.isFavorite || false, clickCount: editingEntry?.clickCount || 0, lastOpened: editingEntry?.lastOpened, status: document.getElementById('statusInput').value, cardColor: document.getElementById('cardColorInput').value, shareCode: editingEntry?.shareCode || await generateUniqueShareCode() };
                await saveEntry(entry);
                showNotification('Entrada guardada', 'success');
                closeAddModal(); await loadEntries(); updateStats();
            } catch (error) { showNotification('Error al guardar', 'error'); }
        });

        function validateForm(name, category, url) { 
            clearErrors(); let ok = true;
            if (!name) { showFieldError('nameError', 'El nombre es obligatorio'); ok = false; }
            if (!category) { showFieldError('categoryError', 'La categor&iacute;a es obligatoria'); ok = false; }
            if (url && !isValidUrl(url)) { showFieldError('urlError', 'URL inv&aacute;lida'); ok = false; }
            return ok;
        }
        function showFieldError(id, msg) { document.getElementById(id).textContent = msg; }
        function clearErrors() { ['nameError', 'categoryError', 'urlError', 'shareCodeInputError'].forEach(id => showFieldError(id, '')); }
        function isValidUrl(s) { try { new URL(s); return true; } catch (e) { return false; } }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file || file.size > 5 * 1024 * 1024) return showNotification('Archivo inv&aacute;lido o muy grande (M&aacute;x 5MB)', 'error');
            try { document.getElementById('imagePreview').src = await compressImage(file); } catch (e) { showNotification('Error al procesar imagen', 'error'); }
        }
        function compressImage(file, maxWidth = 800) { /* ... (código de compresión) ... */ return new Promise(r => r(URL.createObjectURL(file))); }

        async function updateStats() {
            try {
                const entries = await getEntries();
                document.getElementById('totalEntries').textContent = entries.length;
                document.getElementById('totalCategories').textContent = new Set(entries.map(e => e.category)).size;
                document.getElementById('favoriteEntries').textContent = entries.filter(e => e.isFavorite).length;
                document.getElementById('totalClicks').textContent = entries.reduce((s, e) => s + (e.clickCount || 0), 0);
            } catch (e) { console.error(e); }
        }
        
        // ... (resto de funciones como updateUsageCharts, setupEventListeners, etc.)
        // La mayoría no necesitan cambios para la corrección de caracteres.

    </script>
</body>
</html>
