<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunaria Mining Premium</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="#" id="manifest"> 
    <link rel="icon" href="https://i.postimg.cc/GpPsSmmX/4491470.png" type="image/png">
    <meta name="theme-color" content="#06b6d4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Lunaria Mining Premium">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/GpPsSmmX/4491470.png">
    
    <!-- Incluir Supabase JS aqui -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-bg: #0f172a;
            --secondary-bg: #1e293b;
            --card-bg: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #475569;
            --shadow: rgba(0, 0, 0, 0.5);
        }

        [data-theme="light"] {
            --primary-bg: #f8fafc;
            --secondary-bg: #f1f5f9;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent: #0ea5e9;
            --accent-hover: #0284c7;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 100vh; /* Asegura que el body ocupe al menos toda la altura de la pantalla */
            display: flex; /* Permite que el contenido flex se estire */
            flex-direction: column; /* Organiza el contenido en columna */
        }
        
        /* Asegura que el main content ocupe el espacio restante */
        main {
            flex-grow: 1; 
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            width: 100%; /* Asegura que el contenedor siempre ocupe el 100% de su padre */
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex; /* Asegura que la tarjeta use flexbox para su contenido */
            flex-direction: column; /* Organiza el contenido de la tarjeta en columna */
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px var(--shadow);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--card-bg);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 0.5rem;
            font-size: 0.8rem;
            min-width: 35px;
            height: 35px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 2rem;
            width: 90vw; /* Ajuste para moviles */
            max-width: 500px; /* Ancho maximo para pantallas grandes */
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .fullscreen-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--primary-bg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* CAMBIO CLAVE: Alinea el contenido al inicio */
            align-items: center;
            gap: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1rem; /* Padding para evitar que el contenido toque los bordes */
            overflow-y: auto; /* CAMBIO CLAVE: Permite el scroll vertical */
        }

        .fullscreen-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-faucet { background: rgba(34, 197, 94, 0.2); color: var(--success); border: 1px solid var(--success); }
        .category-mining { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .category-staking { background: rgba(14, 165, 233, 0.2); color: var(--accent); border: 1px solid var(--accent); }
        .category-defi { background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid #a855f7; }
        .category-trading { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .category-shorlin { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
        .category-other { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); border: 1px solid var(--text-secondary); }
        .category-favorites { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }


        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 10px 30px var(--shadow); }
        .stat-value { font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .search-filter-bar { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border); }
        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; background: var(--accent); border: none; border-radius: 50%; cursor: pointer; font-size: 1.5rem; color: white; box-shadow: 0 8px 30px rgba(14, 165, 233, 0.4); transition: all 0.3s ease; z-index: 100; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 12px 40px rgba(14, 165, 233, 0.6); }
        .notification { position: fixed; top: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 12px; color: white; font-weight: 600; z-index: 5100; transform: translateX(120%); transition: transform 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: var(--success); }
        .notification.error { background: var(--danger); }
        .notification.warning { background: var(--warning); }
        .notification.info { background: var(--accent); }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }

        .user-id-container {
            position: fixed;
            top: 1rem;
            right: 0;
            display: flex;
            align-items: center;
            z-index: 100;
            transform: translateX(calc(100% - 45px)); /* Oculta el panel, dejando solo el boton visible */
            transition: transform 0.3s ease-in-out;
        }

        .user-id-container.active {
            transform: translateX(0); /* Muestra el panel completo */
        }

        .user-id-toggle-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: background 0.2s ease;
        }

        .user-id-toggle-btn:hover {
            background: var(--accent-hover);
        }

        .user-id-panel {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .user-id-panel span {
            font-weight: 600;
            letter-spacing: 0.05em;
            color: var(--accent);
            order: 2; /* Pone el ID despu茅s del texto "ID de Usuario:" */
        }
        .user-id-copy-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.4s ease;
            order: 1; /* Pone el boton de copiar primero (a la izquierda) */
        }
        .user-id-copy-btn:hover {
            color: var(--accent);
        }

        .card-image-container {
            position: relative;
            overflow: hidden;
        }

        .card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            object-position: center;
            transition: transform 0.6s ease;
        }
        
        .mining-card:hover .card-image {
            transform: scale(1.1);
        }

        .card-top-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .card-top-btn {
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .card-top-btn:hover {
            transform: scale(1.15);
        }
        
        .card-top-btn.favorite-btn.is-favorite {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }

        .card-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.active { background-color: var(--success); }
        .status-dot.attention { background-color: var(--warning); }
        .status-dot.inactive { background-color: var(--danger); }

        .card-url { color: var(--text-secondary); font-size: 0.875rem; word-break: break-all; }
        .card-actions { display: flex; gap: 0.5rem; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 1rem; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        
        .card-footer {
            border-top: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            background-color: rgba(0,0,0,0.1);
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .card-stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .chart-container { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 2rem; }
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-secondary); }
        .empty-state i { font-size: 4rem; color: var(--accent); margin-bottom: 1rem; }
        .filter-chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .filter-chip { padding: 0.5rem 1rem; border-radius: 20px; background: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border); cursor: pointer; transition: all 0.3s ease; font-size: 0.875rem; }
        .filter-chip:hover, .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        /* Estilo para el filtro de favoritos activo */
        .filter-chip[data-category="favorites"].active {
            background: var(--warning);
            color: white;
            border-color: var(--warning);
        }

        .progress-bar { width: 100%; height: 8px; background: var(--secondary-bg); border-radius: 4px; overflow: hidden; margin-top: 1rem; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.3s ease; }
        .update-notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); border: 2px solid var(--accent); border-radius: 20px; padding: 2rem; z-index: 3000; max-width: 600px; width: 90vw; text-align: center; box-shadow: 0 20px 60px var(--shadow); opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .update-notification.show { opacity: 1; visibility: visible; }
        .update-notification h3 { color: var(--accent); font-size: 1.5rem; margin-bottom: 1rem; }
        .update-notification p { color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6; }
        .storage-permission-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 3000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .storage-permission-modal.show { opacity: 1; visibility: visible; }
        .storage-permission-content { background: var(--card-bg); border-radius: 20px; padding: 3rem; max-width: 600px; width: 90vw; text-align: center; border: 2px solid var(--accent); }
        .menu-button { width: 180px; height: 180px; border-radius: 20px; border: none; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1rem; font-size: 1.1rem; font-weight: 600; text-align: center; }
        .menu-button:hover { transform: scale(1.05); }
        .menu-button.faucet-button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; }
        .menu-button.add-button { background: var(--accent); color: white; }
        .menu-button.export-button { background: var(--success); color: white; }
        .menu-button.delete-button { background: var(--danger); color: white; }
        .menu-button.investment-button {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFD166 100%);
            color: white;
            padding: 1rem;
        }
        .menu-button.url-add-button {
            background: linear-gradient(135deg, #53d395 0%, #30c39e 100%);
            color: white;
            padding: 1rem;
        }
        .menu-button.share-all-button {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            color: white;
            padding: 1rem;
        }
        .menu-button.games-menu-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 1rem;
        }
        .menu-button.theme-toggle-menu-button {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            padding: 1rem;
        }
        .menu-button.share-app-button,
        .menu-button.install-button {
            width: 100%; /* Make them wide */
            height: 100px; /* Make them thin */
            padding: 0.5rem 1rem; /* Adjust padding */
            font-size: 1.2rem; /* Slightly larger text */
            flex-direction: row; /* Align icon and text horizontally */
            gap: 1rem; /* Space between icon and text */
            grid-column: span 2; /* Make them span two columns in the grid */
        }
        .menu-button.share-app-button {
            background: linear-gradient(135deg, #FF6F61 0%, #DE483A 100%); /* Reddish-orange */
            color: white;
        }
        .menu-button.install-button {
            background: linear-gradient(135deg, #20BDFF 0%, #A5FECB 100%); /* Light Blue-Green */
            color: white;
        }

        .faucet-logo { width: 120px; height: 80px; border-radius: 8px; object-fit: contain; }
        .close-menu-btn { position: absolute; top: 2rem; right: 2rem; background: var(--danger); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; }
        .close-menu-btn:hover { transform: scale(1.1); }
        .import-progress { background: var(--secondary-bg); border-radius: 8px; padding: 1rem; margin-top: 1rem; display: none; }
        .import-progress.show { display: block; }
        .import-log { background: var(--primary-bg); border-radius: 8px; padding: 1rem; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; color: var(--text-secondary); margin-top: 1rem; }
        .import-log .success { color: var(--success); }
        .import-log .error { color: var(--danger); }
        .import-log .warning { color: var(--warning); }
        .import-log .info { color: var(--accent); }
        .share-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1500; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .share-modal.active { opacity: 1; visibility: visible; }
        .share-content { background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); padding: 2rem; max-width: 90vw; width: 500px; position: relative; }
        .share-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1.5rem; }
        .share-option { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1rem; border-radius: 12px; background: var(--secondary-bg); cursor: pointer; transition: all 0.2s ease; }
        .share-option:hover { transform: translateY(-3px); background: var(--accent); color: white; }
        .share-option i { font-size: 1.5rem; }
        .share-preview { display: flex; align-items: center; gap: 1rem; margin-top: 1rem; padding: 1rem; border-radius: 12px; background: var(--secondary-bg); }
        .share-preview img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8); } 100% { transform: scale(1); opacity: 1; } }
        .scale-animation { animation: scale 0.3s forwards; }
        @keyframes scale { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        
        @media (max-width: 768px) { 
            .container { padding: 0 0.5rem; } 
            .modal-content { min-width: 0; width: 95%; padding: 1.5rem; } 
            .cards-grid { grid-template-columns: 1fr; } 
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); } /* Ajuste de grid para m贸viles */
            .stat-value { font-size: 1.8rem; } /* Ajuste de tama帽o de fuente para m贸viles */
            .fab { bottom: 1rem; right: 1rem; width: 50px; height: 50px; } 
            /* Ajuste para el ID de Usuario en m贸viles */
            .user-id-container { top: 0.5rem; transform: translateX(calc(100% - 35px)); }
            .user-id-container.active { transform: translateX(0); }
            .user-id-toggle-btn { width: 35px; height: 35px; font-size: 1rem; }
            .user-id-panel { padding: 0.3rem 0.6rem; font-size: 0.7rem; }

            .filter-chips { flex-direction: column; align-items: stretch; } 
            .filter-chip { text-align: center; } 
            .fullscreen-modal { gap: 1rem; } 
            .menu-button { width: 150px; height: 150px; } 
            .faucet-logo { width: 100px; height: 60px; } 
            .share-options { grid-template-columns: 1fr 1fr; } 

            /* Responsive styles for wide and thin buttons */
            .menu-button.share-app-button,
            .menu-button.install-button {
                width: 100%;
                height: 80px; /* Make them a bit thinner on mobile */
                font-size: 1rem; /* Smaller text on mobile */
                grid-column: span 2; /* Still span 2 columns */
            }
        }
        .fade-in { animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tooltip { position: absolute; background: var(--secondary-bg); color: var(--text-primary); padding: 0.5rem; border-radius: 6px; font-size: 0.75rem; z-index: 100; pointer-events: none; white-space: nowrap; opacity: 0; transition: opacity 0.2s ease; }
        .tooltip.visible { opacity: 1; }
    </style>
</head>
<body>
    <!-- Modal de Permiso de Almacenamiento -->
    <div id="storagePermissionModal" class="storage-permission-modal">
        <div class="storage-permission-content">
            <h2 class="text-2xl font-bold mb-4 text-blue-400"><i class="fas fa-folder-plus mr-2"></i>Permiso de Almacenamiento</h2>
            <p class="text-gray-300 mb-6">Para garantizar que tus datos esten seguros y respaldados, necesitamos acceso a una carpeta donde guardar automaticamente tus entradas de mineria. Esto te permitirw mantener un respaldo actualizado en caso de futuras actualizaciones.</p>
            <div class="flex gap-4 justify-center">
                <button class="btn btn-primary" onclick="requestStoragePermission()"><i class="fas fa-check"></i>Conceder Permiso</button>
                <button class="btn btn-secondary" onclick="continueWithoutPermission()"><i class="fas fa-times"></i>Continuar sin Permiso</button>
            </div>
        </div>
    </div>

    <!-- Modal de Menu Principal -->
    <div id="mainMenuModal" class="fullscreen-modal">
        <button class="close-menu-btn" onclick="closeMainMenu()"><i class="fas fa-times"></i></button>
        <h2 class="text-3xl font-bold mb-8 text-center"><i class="fas fa-ellipsis-h mr-2"></i>Menu Principal</h2>
        <div class="grid grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-8">
            <button class="menu-button faucet-button" onclick="openExternalUrl('https://faucetpay.io/'); closeMainMenu();"><img src="https://i.postimg.cc/xd3HS5CW/Picsart-25-07-12-19-07-45-544.png" alt="FaucetPay" class="faucet-logo"><span>FaucetPay</span></button>
            <button class="menu-button investment-button" onclick="window.location.href='invercion.html'; closeMainMenu();"><i class="fas fa-money-bill-wave" style="font-size: 3rem;"></i><span>Inversion</span></button>
            <button class="menu-button url-add-button" onclick="openAddUrlModal(); closeMainMenu()"><i class="fas fa-code" style="font-size: 3rem;"></i><span>Integrar Tarjeta</span></button>
            <button class="menu-button share-all-button" onclick="shareAllEntriesAsCollection(); closeMainMenu();"><i class="fas fa-file-export" style="font-size: 3rem;"></i><span>Compartir Todo</span></button>
            <button class="menu-button add-button" onclick="openAddModal(); closeMainMenu()"><i class="fas fa-plus" style="font-size: 3rem;"></i><span>Agregar Pagina</span></button>
            <button class="menu-button export-button" onclick="openExportModal(); closeMainMenu()"><i class="fas fa-download" style="font-size: 3rem;"></i><span>Exportar/Importar</span></button>
            <button class="menu-button delete-button" onclick="showDeleteAllConfirmation(); closeMainMenu()"><i class="fas fa-trash-alt" style="font-size: 3rem;"></i><span>Borrar Todo</span></button>
            <!-- Botones de tema y juegos dentro del menu principal -->
            <button class="menu-button theme-toggle-menu-button" onclick="toggleTheme(); closeMainMenu();"><i id="themeIconMenu" class="fas fa-moon" style="font-size: 3rem;"></i><span>Cambiar Tema</span></button>
            <button class="menu-button games-menu-button" onclick="window.location.href='juegosluminaria.html'; closeMainMenu();"><i class="fas fa-gamepad" style="font-size: 3rem;"></i><span>Tus Juegos</span></button>
            <!-- Botones de compartir app e instalar app -->
            <button class="menu-button share-app-button" onclick="shareApp()"><i class="fas fa-share-square" style="font-size: 3rem;"></i><span>Compartir App</span></button>
            <button id="installAppButton" class="menu-button install-button" onclick="installApp()" style="display: none;"><i class="fas fa-download" style="font-size: 3rem;"></i><span>Instalar App</span></button>
            <!-- NEW: Boton para cerrar sesión -->
            <button class="menu-button delete-button" onclick="signOutUser(); closeMainMenu();"><i class="fas fa-sign-out-alt" style="font-size: 3rem;"></i><span>Cerrar Sesión</span></button>
        </div>
    </div>

    <!-- Notificación de Actualización -->
    <div id="updateNotification" class="update-notification">
        <h3 id="updateNotificationTitle"><i class="fas fa-sparkles mr-2"></i></h3>
        <p id="updateNotificationDescription"></p>
        <button class="btn btn-primary" onclick="closeUpdateNotification()">Entendido!</button>
    </div>

    <!-- ID de Usuario en la parte superior derecha con boton de alternar -->
    <div id="userIdContainer" class="user-id-container">
        <button id="userIdToggleButton" class="user-id-toggle-btn" aria-label="Toggle User ID"><i class="fas fa-angle-left"></i></button>
        <div id="userIdDisplay" class="user-id-panel">
            <button class="user-id-copy-btn" onclick="copyUserIdToClipboard()" data-tooltip="Copiar ID de Usuario">
                <i class="fas fa-copy"></i>
            </button>
            ID de Usuario: <span id="currentUserId"></span>
        </div>
    </div>

    <!-- Cabecera -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-8">
        <div class="container text-center">
            <div class="flex justify-center items-center gap-4 mb-4">
                <img src="https://i.postimg.cc/GpPsSmmX/4491470.png" alt="Logo" class="w-16 h-16">
                <h1 class="text-5xl font-bold">Lunaria Mining Premium</h1>
            </div>
            <p class="text-xl opacity-90">Sneyder Estudio.</p>
        </div>
    </header>

    <!-- Panel de Estadisticas -->
    <section class="py-8">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="totalEntries">0</div><div class="stat-label">Total Entradas</div></div>
                <div class="stat-card"><div class="stat-value" id="totalCategories">0</div><div class="stat-label">Categorias</div></div>
                <div class="stat-card"><div class="stat-value" id="favoriteEntries">0</div><div class="stat-label">Favoritas</div></div>
                <div class="stat-card"><div class="stat-value" id="totalClicks">0</div><div class="stat-label">Clicks Totales</div></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="chart-container"><h3 class="text-xl font-bold mb-4">Piginas Mis Usadas</h3><div style="height: 300px;"><canvas id="pageUsageChart"></canvas></div></div>
                <div class="chart-container"><h3 class="text-xl font-bold mb-4">Categorias Mis Usadas</h3><div style="height: 300px;"><canvas id="categoryUsageChart"></canvas></div></div>
            </div>
        </div>
    </section>

    <!-- Barra de Busqueda y Filtros -->
    <section class="py-4">
        <div class="container">
            <div class="search-filter-bar">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div><label class="block text-sm font-medium mb-2">Buscar</label><div class="relative"><i class="fas fa-search absolute left-3 top-3 text-gray-400"></i><input type="text" id="searchInput" class="form-input pl-10" placeholder="Buscar entradas..."></div></div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Categoria</label>
                        <select id="categoryFilter" class="form-select">
                            <option value="">Todas las categorias</option>
                            <option value="favorites">Favoritos</option>
                            <option value="faucet">Faucets</option>
                            <option value="mining">Mining</option>
                            <option value="staking">Staking</option>
                            <option value="defi">DeFi</option>
                            <option value="trading">Trading</option>
                            <option value="shorlin">Shorlin Fause</option>
                            <option value="other">Otros</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Ordenar por</label>
                        <select id="sortBy" class="form-select">
                            <option value="newest">Mas recientes</option>
                            <option value="oldest">Mas antiguos</option>
                            <option value="favorites">Favoritos primero</option>
                            <option value="mostClicked">Mas clickeados</option>
                            <option value="name">Nombre A-Z</option>
                            <option value="category">Categoria</option>
                        </select>
                    </div>
                </div>
                <div class="filter-chips">
                    <div class="filter-chip active" data-category="">Todas</div>
                    <div class="filter-chip" data-category="favorites"><i class="fas fa-star"></i> Favoritos</div>
                    <div class="filter-chip" data-category="faucet"><i class="fas fa-tint"></i> Faucets</div>
                    <div class="filter-chip" data-category="mining"><i class="fas fa-pickaxe"></i> Mining</div>
                    <div class="filter-chip" data-category="staking"><i class="fas fa-coins"></i> Staking</div>
                    <div class="filter-chip" data-category="defi"><i class="fas fa-chart-line"></i> DeFi</div>
                    <div class="filter-chip" data-category="trading"><i class="fas fa-exchange-alt"></i> Trading</div>
                    <div class="filter-chip" data-category="shorlin"><i class="fas fa-briefcase"></i> Shorlin Fause</div>
                    <div class="filter-chip" data-category="other"><i class="fas fa-ellipsis-h"></i> Otros</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contenido Principal -->
    <main class="py-8">
        <div class="container">
            <div id="emptyState" class="empty-state"><i class="fas fa-gem"></i><h3 class="text-2xl font-bold mb-2">No hay entradas de mineria</h3><p class="mb-4">Comienza agregando tu primera entrada de mineria</p><button class="btn btn-primary" onclick="openAddModal()">Agregar Primera Entrada</button></div>
            <div id="cardsGrid" class="cards-grid"></div>
        </div>
    </main>

    <!-- Boton de Acción Flotante (FAB) y Tooltip -->
    <button class="fab" onclick="openMainMenu()" aria-label="Menu principal"><i class="fas fa-ellipsis-h"></i></button>
    <div id="tooltip" class="tooltip"></div>

    <!-- Modal de Añadir/Editar (Entrada Completa) -->
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-blue-400"><i class="fas fa-plus mr-2"></i><span id="modalTitle">Agregar Entrada de Mineria</span></h2><button class="text-gray-400 hover:text-white text-2xl" onclick="closeAddModal()"><i class="fas fa-times"></i></button></div>
            <form id="miningForm" class="space-y-6">
                <div><label class="block text-sm font-medium mb-2">Imagen de Portada</label><div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors" onclick="document.getElementById('imageInput').click()"><img id="imagePreview" class="w-full max-w-sm h-48 object-cover rounded-lg mx-auto mb-4" src="https://i.postimg.cc/GpPsSmmX/4491470.png" alt="Previsualizaci贸n"><p class="text-gray-400"><i class="fas fa-upload mr-2"></i>Hacer clic para cambiar imagen</p></div><input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)"></div>
                <div><label class="block text-sm font-medium mb-2">Nombre *</label><input type="text" id="nameInput" class="form-input" placeholder="Nombre de la entrada" maxlength="100" required><div id="nameError" class="text-red-500 text-sm mt-1"></div></div>
                <div><label class="block text-sm font-medium mb-2">Categoria *</label><select id="categoryInput" class="form-select" required><option value="">Seleccionar categoria</option><option value="faucet">Faucets</option><option value="mining">Mining</option><option value="staking">Staking</option><option value="defi">DeFi</option><option value="trading">Trading</option><option value="shorlin">Shorlin Fause</option><option value="other">Otros</option></select><div id="categoryError" class="text-red-500 text-sm mt-1"></div></div>
                <div><label class="block text-sm font-medium mb-2">URL</label><input type="url" id="urlInput" class="form-input" placeholder="https://ejemplo.com"><div id="urlError" class="text-red-500 text-sm mt-1"></div></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Estado</label>
                        <select id="statusInput" class="form-select">
                            <option value="active">Activo</option>
                            <option value="attention">Requiere Atención</option>
                            <option value="inactive">Inactivo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Color de la Tarjeta</label>
                        <input type="color" id="cardColorInput" class="form-input h-12 p-1" value="#0ea5e9">
                    </div>
                </div>

                <div><label class="block text-sm font-medium mb-2">Descripcion (Opcional)</label><textarea id="descriptionInput" class="form-input" rows="3" placeholder="Descripcion breve de la entrada"></textarea></div>
                <div><label class="block text-sm font-medium mb-2">Etiquetas (Opcional)</label><input type="text" id="tagsInput" class="form-input" placeholder="bitcoin, ethereum, defi (separadas por comas)"></div>
                <div class="flex gap-4 justify-end"><button type="button" class="btn btn-secondary" onclick="closeAddModal()"><i class="fas fa-times"></i>Cancelar</button><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i><span id="saveButtonText">Guardar</span></button></div>
            </form>
        </div>
    </div>

    <!-- Nuevo Modal: Integrar Tarjeta por Codigo Numerico -->
    <div id="addUrlModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-green-400"><i class="fas fa-code mr-2"></i>Integrar Tarjeta por Codigo Numerico</h2>
                <button class="text-gray-400 hover:text-white text-2xl" onclick="closeAddUrlModal()"><i class="fas fa-times"></i></button>
            </div>
            <form id="addUrlForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2">Pegar Codigo de Tarjeta *</label>
                    <input type="text" id="shareCodeInput" class="form-input" placeholder='Codigo de 10 digitos (ej. 1234567890)' maxlength="10" pattern="\d{10}" required>
                    <div id="shareCodeInputError" class="text-red-500 text-sm mt-1"></div>
                    <p class="text-gray-400 text-sm mt-2">Pega aqui el codigo numerico de 10 digitos de una tarjeta compartida.</p>
                </div>
                <div class="flex gap-4 justify-end">
                    <button type="button" class="btn btn-secondary" onclick="closeAddUrlModal()"><i class="fas fa-times"></i>Cancelar</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-plus"></i>Integrar Tarjeta</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Fin del Nuevo Modal: Integrar Tarjeta por Codigo Numurico -->

    <!-- Modal de Ver Entrada (Opcional, no usado en el JS actual, pero mantener por si acaso) -->
    <div id="viewModal" class="modal"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-blue-400"><i class="fas fa-eye mr-2"></i>Detalles de la Entrada</h2><button class="text-gray-400 hover:text-white text-2xl" onclick="closeViewModal()"><i class="fas fa-times"></i></button></div><div id="viewContent"></div></div></div>

    <!-- Modal de Confirmación -->
    <div id="confirmModal" class="modal"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Confirmar Accion</h2></div><p id="confirmMessage" class="mb-6 text-lg"></p><div class="flex gap-4 justify-end"><button class="btn btn-secondary" onclick="closeConfirmModal()"><i class="fas fa-times"></i>Cancelar</button><button id="confirmActionButton" class="btn btn-danger" onclick="confirmAction()"><i class="fas fa-check"></i>Confirmar</button></div></div></div>

    <!-- Modal de Compartir -->
    <div id="shareModal" class="share-modal"><div class="share-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-green-400"><i class="fas fa-share-alt mr-2"></i>Compartir Entrada</h2><button class="text-gray-400 hover:text-white text-2xl" onclick="closeShareModal()"><i class="fas fa-times"></i></button></div><div id="sharePreview" class="share-preview"><img id="shareImage" src="https://i.postimg.cc/GpPsSmmX/4491470.png" alt="Vista previa"><div><h3 id="shareName" class="font-bold">Nombre de entrada</h3><p id="shareCategory" class="text-sm text-gray-400">Categoria</p></div></div>
        <!-- Display Share Code -->
        <div class="mt-4 p-3 bg-secondary-bg rounded-lg text-center">
            <p class="text-sm text-gray-400 mb-2">Codigo de Compartir:</p>
            <p id="displayShareCode" class="text-3xl font-bold text-accent tracking-widest">CARGANDO...</p>
        </div>
        <div class="share-options">
            <div class="share-option" onclick="copyShareCode()"><i class="fas fa-copy"></i><span>Copiar Codigo</span></div>
            <div class="share-option" onclick="shareCodeViaApp('WhatsApp')"><i class="fab fa-whatsapp"></i><span>WhatsApp</span></div>
            <div class="share-option" onclick="shareCodeViaApp('Telegram')"><i class="fab fa-telegram"></i><span>Telegram</span></div>
            <div class="share-option" onclick="shareCodeViaApp('Messenger')"><i class="fab fa-facebook-messenger"></i><span>Messenger</span></div>
            <div class="share-option" onclick="shareCodeViaApp('Email')"><i class="fas fa-envelope"></i><span>Email</span></div>
            <div class="share-option" onclick="shareCodeViaApp('Web Share')"><i class="fas fa-share-alt"></i><span>Web Share</span></div>
        </div>
    </div></div>

    <!-- Modal de Exportar/Importar -->
    <div id="exportModal" class="modal"><div class="modal-content"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-blue-400"><i class="fas fa-download mr-2"></i>Exportar/Importar Datos</h2><button class="text-gray-400 hover:text-white text-2xl" onclick="closeExportModal()"><i class="fas fa-times"></i></button></div><div class="space-y-6"><div><h3 class="text-lg font-semibold mb-4">Exportar Datos</h3><div class="flex gap-4"><button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i>Descargar JSON</button><button class="btn btn-secondary" onclick="exportCSV()"><i class="fas fa-file-csv"></i>Descargar CSV</button></div></div><div><h3 class="text-lg font-semibold mb-4">Importar Datos</h3><input type="file" id="importFile" accept=".json,.csv" class="form-input mb-4"><button class="btn btn-success" onclick="importData()"><i class="fas fa-upload"></i>Importar Archivo</button><div id="importProgress" class="import-progress"><div class="flex items-center justify-between mb-2"><span>Procesando archivo...</span><div class="loading-spinner"></div></div><div class="progress-bar"><div id="importProgressBar" class="progress-fill" style="width: 0%"></div></div><div id="importLog" class="import-log"></div></div></div></div>

    <!-- Modal para confirmar la instalacion de la tarjeta (NO SE USA MAS PARA EVA, SOLO PARA JSON) -->
    <div id="installCardModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-green-400 mb-4"><i class="fas fa-download mr-2"></i>Tarjeta Recibida</h2>
            <p class="mb-6 text-lg">Se ha detectado la siguiente tarjeta. ¿Deseas unirla a tu aplicacion?</p>
            <div id="installCardPreview" class="share-preview mb-6">
                <img id="installCardImage" src="https://i.postimg.cc/GpPsSmmX/4491470.png" alt="Vista previa">
                <div>
                    <h3 id="installCardName" class="font-bold">Nombre de entrada</h3>
                    <p id="installCardCategory" class="text-sm text-gray-400">Categoria</p>
                </div>
            </div>
            <div class="flex gap-4 justify-end">
                <button class="btn btn-secondary" onclick="closeInstallCardModal()"><i class="fas fa-times"></i>Cancelar</button>
                <button class="btn btn-success" onclick="confirmInstallIncomingCard()">Unir Tarjeta</button>
            </div>
        </div>
    </div>

    <script>
        // *** CONFIGURACIÓN DE SUPABASE ***
        const SUPABASE_URL = 'https://pfiidibdkyxgerklpivy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmaWlkaWJka3l4Z2Vya2xwaXZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5MTc5NjEsImV4cCI6MjA3MTQ5Mzk2MX0.mAwZnH2ZGhWH2b5Mml3HGLPc7qRckw13zNHFCOXcz7c';
        const REDIRECT_LOGIN_URL = './auth.html'; // URL de la p谩gina de login
        
        // Inicializar cliente de Supabase
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Variables globales
        let editingEntry = null;
        let confirmCallback = null;
        let pageUsageChart = null;
        let categoryUsageChart = null;
        let directoryHandle = null;
        let storagePermissionGranted = false;
        let currentShareEntry = null;
        let tooltipTimeout = null;
        let currentUpdateIdShown = null;
        let incomingCardData = null;
        let currentUserId = null; // ID del usuario de Supabase
        let currentUserEmail = null; // Email del usuario de Supabase
        let isUserIdPanelActive = false;
        let collectionShareCode = null; // C贸digo de colecci贸n del usuario actual
        let deferredPrompt = null;
        
        const appUpdates = [
            { id: 'v1.0.0', title: 'Bienvenido a Lunaria Mining Premium!', description: 'Hemos lanzado la aplicacion para ayudarte a gestionar tus entradas de mineria. Esperamos que te sea muy Util!' },
            { id: 'v1.1.0', title: 'Nuevas Funciones Disponibles!', description: 'Hemos mejorado la aplicacion. Ahora puedes compartir las tarjetas directamente a traves de las aplicaciones de mensajeria de tu dispositivo con la nueva funcion de compartir. Ademas, hemos añadido una nueva categoria <strong>"Shorlin Fause"</strong> especialmente diseñada para paginas donde puedes realizar trabajo como ver anuncios, hacer ciertas tareas, y generar ingresos adicionales.' },
            { id: 'v1.2.0', title: 'Mejoras en la Interfaz y Rendimiento!', description: 'Hemos optimizado la interfaz de usuario para una navegación mas fluida y una experiencia visual mejorada. Tambien se han realizado ajustes internos para un rendimiento mas rapido. Disfrutalo!' },
            { id: 'v1.3.0', title: 'Graficas de Uso y Notificaciones Automaticas!', description: 'Ahora puedes ver las paginas y categorias que mas usas en nuevas graficas de barras dinamicas. Ademas, recibiras notificaciones automaticas con cada actualizacion importante de la aplicacion. Mantente al dia con las novedades!' },
            { id: 'v1.4.0', title: 'Integración Avanzada de Archivos!', description: 'Ahora puedes **abrir directamente tus archivos JSON y CSV** con la aplicacion Lunaria Mining Premium desde el explorador de archivos de tu dispositivo. Tambien apareceremos en la opción "Abrir con" para que importar tus tarjetas sea mas facil que nunca. Comparte tus datos sin esfuerzo!' },
            { id: 'v1.5.0', title: 'Tarjetas Super Personalizables!', description: 'Tus tarjetas ahora son mas inteligentes! Añade a <strong>favoritos</strong>, mira las <strong>estadisticas de clicks</strong>, asigna un <strong>estado</strong> (activo, inactivo), personaliza el <strong>color</strong>, genera <strong>codigos QR</strong>, <strong>copia URLs</strong> con un click y <strong>duplica</strong> tus tarjetas facilmente. Organiza como nunca antes!' },
            { id: 'v1.6.0', title: 'Navegación Mejorada y Botón de Invercion!', description: 'Hemos eliminado el navegador interno para una mejor compatibilidad con sitios web que tienen restricciones de seguridad, abriendo todo en nuevas pestañas. Ademas, añadimos un nuevo botón de **Inversion** en el menu principal.' },
            { id: 'v1.7.0', title: 'Compartir Tarjetas con Codigo Numurico!', description: 'Ahora puedes compartir tus tarjetas con un codigo de 10 digitos. Copia el codigo y enviaselo a tus amigos para que integren la tarjeta en su aplicacion. Mas facil que nunca!' },
            { id: 'v1.7.1', title: 'Aclaración de Codigos de Compartir', description: 'El codigo de compartir de 10 digitos es **siempre numerico**. Si viste caracteres extraños, por favor indicanos donde. Los IDs internos de las tarjetas pueden contener letras y numeros, pero estos no se muestran al usuario.' },
            { id: 'v1.7.2', title: 'Compartir Mejorado y Claridad en URL', description: 'Los botones de compartir ahora abren directamente las aplicaciones (WhatsApp, Telegram, Email) con el mensaje pre-rellenado. El botón "Copiar URL" de la tarjeta ahora copia exclusivamente la URL, como esperabas. (Messenger sigue copiando al portapapeles).' },
            { id: 'v1.7.3', title: 'Tu ID de Usuario Personal!', description: 'Hemos añadido un <strong>ID de usuario unico de 8 digitos</strong> que se muestra en la esquina superior derecha. Ahora puedes copiarlo facilmente. Tambien, el botón "Integrar Codigo" se ha renombrado a "Integrar Tarjeta".' },
            { id: 'v1.7.4', title: 'Compartir Optimizado: Solo el Codigo y sin Garabatos!', description: 'Hemos corregido los problemas de codificación al compartir. Ahora, al usar WhatsApp, Telegram o Email, se enviara **solo el codigo de la tarjeta**, sin mensajes adicionales ni caracteres extraños. Para Messenger y Web Share, el mensaje completo se copiar correctamente al portapapeles.' },
            { id: 'v1.7.5', title: 'Interfaz Limpia: Menu Centralizado e ID Fijo', description: 'Hemos movido los botones de "Cambiar Tema" y "Tus Juegos" al menu principal. Tu ID de usuario ahora se muestra fijo en la esquina superior derecha, con el botón de copiar a la izquierda del texto.' },
            { id: 'v1.8.0', title: 'Adios a los duplicados de URL!', description: 'La aplicacion ahora es mas inteligente al detectar tarjetas duplicadas. Ignora los numeros de referencia en las URLs **solo para la comparacion**, pero **guarda y utiliza siempre el enlace completo** para no perder tus recompensas de referidos. Organiza tu colección sin preocupaciones!' }
        ];

        const categories = {
            faucet: { name: 'Faucets', icon: 'fas fa-tint', color: '#22c55e' },
            mining: { name: 'Mining', icon: 'fas fa-pickaxe', color: '#f59e0b' },
            staking: { name: 'Staking', icon: 'fas fa-coins', color: '#0ea5e9' },
            defi: { name: 'DeFi', icon: 'fas fa-chart-line', color: '#a855f7' },
            trading: { name: 'Trading', icon: 'fas fa-exchange-alt', color: '#ef4444' },
            shorlin: { name: 'Shorlin Fause', icon: 'fas fa-briefcase', color: '#10b981' },
            other: { name: 'Otros', icon: 'fas fa-ellipsis-h', color: '#6b7280' },
            favorites: { name: 'Favoritos', icon: 'fas fa-star', color: '#f59e0b' }
        };

        const barColors = ['rgba(255, 99, 132, 0.8)', 'rgba(54, 162, 235, 0.8)', 'rgba(255, 206, 86, 0.8)', 'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)', 'rgba(199, 199, 199, 0.8)', 'rgba(83, 102, 255, 0.8)', 'rgba(255, 99, 255, 0.8)', 'rgba(99, 255, 132, 0.8)'];

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            console.log("Initializing App...");
            
            // 1. Verificar la sesion de Supabase al cargar la aplicacion principal
            const { data: { session }, error } = await supabaseClient.auth.getSession();

            if (error) {
                console.error("Error al obtener la sesión de Supabase:", error);
                showNotification("Error de autenticación. Redirigiendo...", 'error', true);
                setTimeout(() => window.location.href = REDIRECT_LOGIN_URL, 2000);
                return;
            }

            if (!session) {
                console.log("No hay sesión activa. Redirigiendo a la pagina de login.");
                showNotification("No has iniciado sesión. Redirigiendo...", 'warning', true);
                setTimeout(() => window.location.href = REDIRECT_LOGIN_URL, 2000);
                return;
            }

            // Si hay sesión, configurar el usuario actual
            currentUserId = session.user.id; 
            currentUserEmail = session.user.email;
            console.log("Usuario Supabase autenticado:", session.user);
            showNotification(`Bienvenido, ${currentUserEmail}!`, 'success');

            // Continuar con la inicialización normal de la aplicacion
            // initializeDatabase() ya no es relevante, se deja solo el log
            console.log("IndexedDB initialization skipped, using Supabase for data persistence.");
            
            await loadOrCreateUserId(); // Esta función ahora se adapta al ID de Supabase
            await loadOrCreateCollectionShareCode();
            await loadEntries(); // Ahora cargara las entradas del usuario actual
            setupEventListeners();
            updateStats();
            updateUsageCharts();
            loadTheme();
            checkStoragePermission(); // Mantener para el backup local si el usuario lo permite
            checkAppUpdates();
            setupToolTip();
            
            document.getElementById('userIdToggleButton').addEventListener('click', toggleUserIdVisibility);

            if ('launchQueue' in window) {
                launchQueue.setConsumer(async (launchParams) => {
                    if (!launchParams || !launchParams.files || launchParams.files.length === 0) return;
                    showNotification('Detectando archivo entrante...', 'info');
                    for (const fileHandle of launchParams.files) {
                        try {
                            const file = await fileHandle.getFile();
                            showNotification(`Procesando archivo: ${file.name}`, 'info');
                            await importData(file);
                        } catch (error) {
                            console.error('Error al procesar archivo entrante:', error);
                            showNotification(`Error al procesar el archivo: ${error.message}`, 'error');
                        }
                    }
                });
            }

            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (!window.matchMedia('(display-mode: standalone)').matches && !navigator.standalone) {
                    const installButton = document.getElementById('installAppButton');
                    if (installButton) {
                        installButton.style.display = 'flex';
                    }
                }
            });

            window.addEventListener('appinstalled', () => {
                const installButton = document.getElementById('installAppButton');
                if (installButton) {
                    installButton.style.display = 'none';
                }
                deferredPrompt = null;
                showNotification('Lunaria Mining Premium ha sido instalada!', 'success');
            });

            if (window.matchMedia('(display-mode: standalone)').matches || navigator.standalone) {
                const installButton = document.getElementById('installAppButton');
                if (installButton) {
                    installButton.style.display = 'none';
                }
            } else {
                const installButton = document.getElementById('installAppButton');
                if (installButton) {
                    installButton.style.display = 'none'; 
                }
            }
            
            console.log("App initialized.");
        }

        function setupToolTip() {
            const tooltip = document.getElementById('tooltip');
            document.addEventListener('mouseover', (e) => {
                const target = e.target.closest('[data-tooltip]');
                if (target) {
                    tooltip.textContent = target.getAttribute('data-tooltip');
                    const rect = target.getBoundingClientRect();
                    tooltip.style.left = `${rect.left + rect.width / 2}px`;
                    tooltip.style.top = `${rect.top}px`;
                    tooltip.style.transform = 'translate(-50%, -110%)';
                    clearTimeout(tooltipTimeout);
                    tooltipTimeout = setTimeout(() => tooltip.classList.add('visible'), 200);
                }
            });
            document.addEventListener('mouseout', (e) => {
                if (e.target.closest('[data-tooltip]')) {
                    clearTimeout(tooltipTimeout);
                    tooltip.classList.remove('visible');
                }
            });
        }

        async function checkStoragePermission() {
            const hasSeenPermission = localStorage.getItem('storagePermissionChecked');
            if (!hasSeenPermission) {
                setTimeout(() => document.getElementById('storagePermissionModal').classList.add('show'), 1000);
            } else {
                storagePermissionGranted = localStorage.getItem('storagePermissionGranted') === 'true';
            }
        }

        async function requestStoragePermission() {
            try {
                if ('showDirectoryPicker' in window) {
                    directoryHandle = await window.showDirectoryPicker();
                    storagePermissionGranted = true;
                    localStorage.setItem('storagePermissionGranted', 'true');
                    localStorage.setItem('storagePermissionChecked', 'true');
                    showNotification('Permiso de almacenamiento concedido', 'success');
                    await createBackup();
                } else {
                    showNotification('API de sistema de archivos no disponible en este navegador', 'warning');
                    continueWithoutPermission();
                }
            } catch (error) {
                console.error('Error al solicitar permiso de almacenamiento:', error);
                showNotification('Error al solicitar permiso de almacenamiento', 'error');
                continueWithoutPermission();
            }
            document.getElementById('storagePermissionModal').classList.remove('show');
        }

        function continueWithoutPermission() {
            localStorage.setItem('storagePermissionChecked', 'true');
            localStorage.setItem('storagePermissionGranted', 'false');
            document.getElementById('storagePermissionModal').classList.remove('show');
            showNotification('Continuando sin permiso de almacenamiento', 'info');
        }

        async function createBackup() {
            if (!storagePermissionGranted || !directoryHandle || !currentUserId) return;
            try {
                const entries = await getEntries();
                const backupData = { 
                    timestamp: new Date().toISOString(), 
                    version: '1.8.0', 
                    userId: currentUserId,
                    userEmail: currentUserEmail,
                    entries: entries 
                };
                const fileName = `lunaria_backup_${currentUserId}_${new Date().toISOString().split('T')[0]}.json`;
                
                const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(backupData, null, 2));
                await writable.close();
                console.log('Copia de seguridad creada con Exito');
            } catch (error) {
                console.error('Error al crear copia de seguridad:', error);
            }
        }

        function openMainMenu() { document.getElementById('mainMenuModal').classList.add('active'); }
        function closeMainMenu() { document.getElementById('mainMenuModal').classList.remove('active'); }

        async function checkAppUpdates() {
            const lastSeenUpdateId = localStorage.getItem('lastSeenAppUpdateId');
            const latestUpdate = appUpdates[appUpdates.length - 1];
            if (latestUpdate && latestUpdate.id !== lastSeenUpdateId) {
                document.getElementById('updateNotificationTitle').innerHTML = `<i class="fas fa-sparkles mr-2"></i> ${latestUpdate.title}`;
                document.getElementById('updateNotificationDescription').innerHTML = latestUpdate.description;
                document.getElementById('updateNotification').classList.add('show');
                currentUpdateIdShown = latestUpdate.id;
            }
        }

        function closeUpdateNotification() {
            document.getElementById('updateNotification').classList.remove('show');
            if (currentUpdateIdShown) {
                localStorage.setItem('lastSeenAppUpdateId', currentUpdateIdShown);
                currentUpdateIdShown = null;
            }
        }

        async function openShareModal(id) {
            try {
                const { data: entry, error } = await supabaseClient
                    .from('entries')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error || !entry) {
                    console.error("Error fetching entry for share:", error);
                    return showNotification('Entrada no encontrada o no tienes permiso.', 'error');
                }

                // El RLS ya asegura que solo el propietario puede leer, asi que no se necesita verificación adicional.
                // Generar shareCode si no existe
                if (!entry.share_code) {
                    entry.share_code = await generateUniqueShareCode();
                    await saveEntry(entry); // Actualiza la entrada con el share_code
                }

                currentShareEntry = entry;
                document.getElementById('shareImage').src = entry.image;
                document.getElementById('shareName').textContent = entry.name;
                document.getElementById('shareCategory').textContent = categories[entry.category]?.name || 'Otra categoria';
                document.getElementById('displayShareCode').textContent = entry.share_code; // Usar share_code de Supabase
                document.getElementById('shareModal').classList.add('active');
            } catch (error) {
                console.error('Error al obtener la entrada para compartir o generar el codigo:', error);
                showNotification('Error al preparar la entrada para compartir', 'error');
            }
        }

        function closeShareModal() { document.getElementById('shareModal').classList.remove('active'); currentShareEntry = null; }

        function copyShareCode() {
            if (!currentShareEntry || !currentShareEntry.share_code) { // Usar share_code
                return showNotification('No hay codigo de compartir para copiar', 'warning');
            }
            try {
                const codeToCopy = currentShareEntry.share_code; // Usar share_code
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(codeToCopy)
                        .then(() => {
                            showNotification('Codigo de compartir copiado al portapapeles', 'success');
                            closeShareModal();
                        })
                        .catch(err => {
                            console.error('Error al copiar el codigo usando la API del Portapapeles:', err);
                            copyTextToClipboardLegacy(codeToCopy);
                        });
                } else {
                    copyTextToClipboardLegacy(codeToCopy);
                }
            } catch (error) {
                console.error('Error al copiar el codigo para compartir:', error);
                showNotification('Error al copiar el codigo de la tarjeta', 'error');
            }
        }

        function shareCodeViaApp(platformName) {
            if (!currentShareEntry || !currentShareEntry.share_code) { // Usar share_code
                return showNotification('No hay codigo de compartir para enviar', 'warning');
            }
            const codeToShare = currentShareEntry.share_code; // Usar share_code
            
            let shareTitle = currentShareEntry.id === 'collection' 
                ? 'Colección de Tarjetas Lunaria Mining Premium' 
                : `Tarjeta ${currentShareEntry.name} de Lunaria Mining Premium`;

            let shareBodyMessage = currentShareEntry.id === 'collection'
                ? `Mira mi colección de tarjetas de Lunaria Mining Premium! Codigo: ${codeToShare}. Pegalo en la sección "Integrar Tarjeta" de tu app.`
                : `Mira esta tarjeta de Lunaria Mining Premium! Codigo: ${codeToShare}. Pegalo en la sección "Integrar Tarjeta" de tu app.`;

            let shareUrl = '';

            switch (platformName) {
                case 'WhatsApp':
                    shareUrl = `https://wa.me/?text=${encodeURIComponent(shareBodyMessage)}`; 
                    break;
                case 'Telegram':
                    shareUrl = `https://t.me/share/url?text=${encodeURIComponent(shareBodyMessage)}`; 
                    break;
                case 'Email':
                    shareUrl = `mailto:?subject=${encodeURIComponent(shareTitle)}&body=${encodeURIComponent(shareBodyMessage)}`; 
                    break;
                case 'Messenger': 
                    copyTextToClipboardLegacy(shareBodyMessage); 
                    showNotification(`Mensaje con codigo copiado al portapapeles. Pegalo en Messenger.`, 'info');
                    closeShareModal();
                    return; 
                case 'Web Share':
                    if (navigator.share) {
                        navigator.share({
                            title: shareTitle,
                            text: shareBodyMessage
                        })
                        .then(() => showNotification('Codigo compartido con Exito', 'success'))
                        .catch((error) => console.error('Error al compartir via Web Share', error));
                    } else {
                        copyTextToClipboardLegacy(shareBodyMessage);
                        showNotification('Tu dispositivo no soporta Web Share. Mensaje con codigo copiado al portapapeles.', 'info');
                    }
                    closeShareModal();
                    return; 
                default:
                    showNotification('Plataforma de compartir no reconocida.', 'error');
                    closeShareModal();
                    return;
            }

            if (shareUrl) {
                window.open(shareUrl, '_blank');
                showNotification(`Mensaje listo para compartir en ${platformName}.`, 'success');
            }
            closeShareModal();
        }

        async function shareAllEntriesAsCollection() { 
            try {
                if (!collectionShareCode) {
                    await loadOrCreateCollectionShareCode();
                }

                if (!collectionShareCode) {
                    return showNotification('No se pudo generar un codigo de compartir para la colección.', 'error');
                }
                
                currentShareEntry = {
                    id: 'collection',
                    name: 'Todas tus tarjetas',
                    category: 'Coleccion completa',
                    image: 'https://i.postimg.cc/GpPsSmmX/4491470.png',
                    share_code: collectionShareCode // Usar share_code
                };

                document.getElementById('shareImage').src = currentShareEntry.image;
                document.getElementById('shareName').textContent = currentShareEntry.name;
                document.getElementById('shareCategory').textContent = currentShareEntry.category;
                document.getElementById('displayShareCode').textContent = currentShareEntry.share_code; // Usar share_code
                document.getElementById('shareModal').classList.add('active');

            } catch (error) {
                console.error('Error al intentar compartir todas las entradas:', error);
                showNotification('Error al intentar compartir todas las tarjetas.', 'error');
            }
        }


        function copyTextToClipboardLegacy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
            } catch (error) {
                showNotification('Error al copiar el texto. Tu navegador no soporta la copia automatica.', 'error');
                console.error('Error al copiar texto con execCommand:', error);
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // initializeDatabase (IndexedDB) ya no es relevante para los datos principales
        // pero se mantiene para la estructura si se usa para algo mas (ej. cacho).
        // Para esta migración, simplemente la dejaremos vacia o eliminarla si no se necesita.
        async function initializeDatabase() {
            // No IndexedDB initialization needed for main data, now using Supabase
            console.log("IndexedDB initialization skipped, using Supabase for data persistence.");
            return Promise.resolve();
        }


        // Adaptada para usar Supabase
        async function saveEntry(entryData) {
            if (!currentUserId) {
                showNotification('Error: No se pudo guardar la entrada. ID de usuario no disponible.', 'error');
                throw new Error('No se puede guardar la entrada sin un ID de usuario.');
            }

            const formattedEntry = {
                user_id: currentUserId,
                name: entryData.name,
                category: entryData.category,
                url: entryData.url,
                description: entryData.description,
                tags: entryData.tags, // Supabase soporta arrays directamente
                image: entryData.image,
                is_favorite: entryData.isFavorite,
                click_count: entryData.clickCount,
                last_opened: entryData.lastOpened,
                status: entryData.status,
                card_color: entryData.cardColor,
                share_code: entryData.shareCode // Share code
            };

            if (entryData.id) { // Si existe un ID, es una actualización
                const { data, error } = await supabaseClient
                    .from('entries')
                    .update(formattedEntry)
                    .eq('id', entryData.id)
                    .select()
                    .single();

                if (error) {
                    console.error("Error updating entry:", error);
                    throw error;
                }
                if (storagePermissionGranted) createBackup();
                return data;
            } else { // Si no hay ID, es una nueva entrada
                const { data, error } = await supabaseClient
                    .from('entries')
                    .insert(formattedEntry)
                    .select()
                    .single();

                if (error) {
                    console.error("Error inserting entry:", error);
                    throw error;
                }
                if (storagePermissionGranted) createBackup();
                return data;
            }
        }

        // Adaptada para usar Supabase
        async function getEntries() {
            if (!currentUserId) {
                console.warn('Intentando obtener entradas sin ID de usuario. Devolviendo vacio.');
                return [];
            }

            const { data, error } = await supabaseClient
                .from('entries')
                .select('*')
                // RLS ya deberia filtrar por user_id, pero lo dejamos explicito por claridad
                .eq('user_id', currentUserId);

            if (error) {
                console.error("Error fetching entries:", error);
                throw error;
            }

            // Adaptar nombres de columnas de Supabase a los esperados por el frontend
            return data.map(entry => ({
                ...entry,
                isFavorite: entry.is_favorite,
                clickCount: entry.click_count,
                lastOpened: entry.last_opened,
                cardColor: entry.card_color,
                shareCode: entry.share_code,
                ownerId: entry.user_id // Mantener para compatibilidad interna
            }));
        }

        // Adaptada para usar Supabase
        async function getEntryById(id) {
            if (!currentUserId) {
                console.warn('Intentando obtener entrada por ID sin ID de usuario. Fallo.');
                return null;
            }

            const { data, error } = await supabaseClient
                .from('entries')
                .select('*')
                .eq('id', id)
                .eq('user_id', currentUserId) // RLS tambión filtra, pero es una buena practica
                .single();

            if (error) {
                console.error("Error fetching entry by ID:", error);
                // Si el error es por no encontrar la fila (ej. RLS), simplemente devuelve null
                if (error.code === 'PGRST116') return null; // No row found
                throw error;
            }
            
            // Adaptar nombres de columnas de Supabase
            return {
                ...data,
                isFavorite: data.is_favorite,
                clickCount: data.click_count,
                lastOpened: data.last_opened,
                cardColor: data.card_color,
                shareCode: data.share_code,
                ownerId: data.user_id
            };
        }

        // Adaptada para usar Supabase
        async function deleteEntry(id) {
            if (!currentUserId) {
                showNotification('Error: No se pudo eliminar la entrada. ID de usuario no disponible.', 'error');
                throw new Error('No se puede eliminar la entrada sin un ID de usuario.');
            }
            
            // RLS ya asegura que solo el propietario puede eliminar su propia entrada.
            const { error } = await supabaseClient
                .from('entries')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUserId); // Doble verificación

            if (error) {
                console.error("Error deleting entry:", error);
                throw error;
            }
            if (storagePermissionGranted) createBackup();
            return true;
        }

        // Adaptada para usar Supabase
        async function trackPageUsage(url, name) {
            if (!url || !currentUserId) return;

            // Primero, intentar encontrar una entrada existente para este usuario y URL
            const { data: existingUsage, error: selectError } = await supabaseClient
                .from('page_usage')
                .select('*')
                .eq('user_id', currentUserId)
                .eq('url', url)
                .single();

            if (selectError && selectError.code !== 'PGRST116') { // PGRST116 = No row found
                console.error("Error checking existing page usage:", selectError);
                throw selectError;
            }

            let dataToStore = {
                user_id: currentUserId,
                url: url,
                name: name,
                count: 1
            };

            if (existingUsage) {
                dataToStore.count = existingUsage.count + 1;
                const { error: updateError } = await supabaseClient
                    .from('page_usage')
                    .update(dataToStore)
                    .eq('id', existingUsage.id);
                if (updateError) {
                    console.error("Error updating page usage:", updateError);
                    throw updateError;
                }
            } else {
                const { error: insertError } = await supabaseClient
                    .from('page_usage')
                    .insert(dataToStore);
                if (insertError) {
                    console.error("Error inserting page usage:", insertError);
                    throw insertError;
                }
            }
            updatePageUsageChart();
        }

        // Adaptada para usar Supabase
        async function trackCategoryUsage(categoryKey) {
            if (!categoryKey || !currentUserId) return;

            // Primero, intentar encontrar una entrada existente para este usuario y categoria
            const { data: existingUsage, error: selectError } = await supabaseClient
                .from('category_usage')
                .select('*')
                .eq('user_id', currentUserId)
                .eq('category', categoryKey)
                .single();

            if (selectError && selectError.code !== 'PGRST116') {
                console.error("Error checking existing category usage:", selectError);
                throw selectError;
            }

            let dataToStore = {
                user_id: currentUserId,
                category: categoryKey,
                name: categories[categoryKey]?.name || categoryKey,
                count: 1
            };

            if (existingUsage) {
                dataToStore.count = existingUsage.count + 1;
                const { error: updateError } = await supabaseClient
                    .from('category_usage')
                    .update(dataToStore)
                    .eq('id', existingUsage.id);
                if (updateError) {
                    console.error("Error updating category usage:", updateError);
                    throw updateError;
                }
            } else {
                const { error: insertError } = await supabaseClient
                    .from('category_usage')
                    .insert(dataToStore);
                if (insertError) {
                    console.error("Error inserting category usage:", insertError);
                    throw insertError;
                }
            }
            updateCategoryUsageChart();
        }

        // Adaptada para usar Supabase
        async function getPageUsageStats() {
            if (!currentUserId) return [];
            const { data, error } = await supabaseClient
                .from('page_usage')
                .select('*')
                .eq('user_id', currentUserId); // RLS ya deberia filtrar
            if (error) {
                console.error("Error fetching page usage stats:", error);
                throw error;
            }
            return data;
        }

        // Adaptada para usar Supabase
        async function getCategoryUsageStats() {
            if (!currentUserId) return [];
            const { data, error } = await supabaseClient
                .from('category_usage')
                .select('*')
                .eq('user_id', currentUserId); // RLS ya deberia filtrar
            if (error) {
                console.error("Error fetching category usage stats:", error);
                throw error;
            }
            return data;
        }
        
        function getCanonicalUrl(rawUrl) {
            if (!rawUrl) return '';
            try {
                const urlObj = new URL(rawUrl);
                let pathSegments = urlObj.pathname.split('/').filter(segment => segment !== '');

                if (pathSegments.length > 0 && /^\d+$/.test(pathSegments[pathSegments.length - 1])) {
                    pathSegments.pop();
                }

                let newPathname = '/' + pathSegments.join('/');
                if (rawUrl.endsWith('/') && newPathname !== '/') {
                     newPathname += '/';
                }
                if (newPathname.endsWith('/') && newPathname.length > 1) {
                    newPathname = newPathname.slice(0, -1);
                }


                return urlObj.origin + newPathname;
            } catch (e) {
                console.warn(`No se pudo analizar la URL para la forma canonica (ignorando segmentos numericos y query/hash): ${rawUrl}`, e);
                return rawUrl;
            }
        }

        // Adaptada para usar Supabase
        async function findEntryByNameAndUrl(name, rawUrl) {
            if (!currentUserId) return null;

            const canonicalIncomingUrl = getCanonicalUrl(rawUrl);
            const { data, error } = await supabaseClient
                .from('entries')
                .select('*')
                .eq('user_id', currentUserId)
                .eq('name', name)
                .like('url', `${canonicalIncomingUrl}%`); // Usa 'like' para buscar URLs que empiecen con la canonical

            if (error) {
                console.error("Error finding entry by name and URL:", error);
                throw error;
            }

            // Realiza una verificación mas precisa en el cliente para el URL canonico
            return data.find(entry => getCanonicalUrl(entry.url) === canonicalIncomingUrl) || null;
        }

        // Adaptada para usar Supabase (utiliza la función RPC)
        async function findEntryByShareCode(code) {
            if (!code) return null;

            const { data, error } = await supabaseClient.rpc('rpc_get_shared_entry_by_code', { p_share_code: code });

            if (error) {
                console.error("Error calling rpc_get_shared_entry_by_code:", error);
                throw error;
            }
            
            // rpc_get_shared_entry_by_code devuelve un array, esperamos el primer elemento si existe
            const entry = data && data.length > 0 ? data[0] : null;

            if (entry) {
                // Adaptar los nombres de las columnas de Supabase a los esperados por el frontend
                return {
                    ...entry,
                    isFavorite: entry.is_favorite,
                    clickCount: entry.click_count,
                    lastOpened: entry.last_opened,
                    cardColor: entry.card_color,
                    shareCode: entry.share_code,
                    ownerId: entry.user_id // Este `user_id` sera el del creador original, no el del usuario actual
                };
            }
            return null;
        }

        // Adaptada para usar Supabase (la unicidad se verifica en la tabla Supabase)
        async function generateUniqueShareCode() {
            let code;
            let isUnique = false;
            const maxRetries = 100;

            for (let i = 0; i < maxRetries && !isUnique; i++) {
                code = Math.floor(1000000000 + Math.random() * 9000000000).toString(); 
                try {
                    // Supabase enforces UNIQUE constraint on share_code, so try to insert a dummy
                    // or select to check existence. A simple select is more appropriate here.
                    const { data, error } = await supabaseClient
                        .from('entries')
                        .select('share_code')
                        .eq('share_code', code)
                        .single();
                    
                    if (error && error.code === 'PGRST116') { // No row found, code is unique
                        isUnique = true;
                    } else if (!error && data) { // Found a row, code is not unique
                        isUnique = false;
                    } else { // Other errors
                        console.error("Error checking shareCode uniqueness on Supabase:", error);
                        isUnique = false; // Assume not unique on error to retry
                    }
                } catch (error) {
                    console.error("Error checking shareCode uniqueness during RPC:", error);
                    isUnique = false;
                }
            }
            if (!isUnique) {
                console.warn("No se pudo generar un codigo de compartir unico despues de varios reintentos.");
                throw new Error("No se pudo generar un codigo de compartir unico.");
            }
            return code;
        }

        // Adaptada para usar Supabase
        async function getUserSetting(key) {
            if (!currentUserId) return null;

            const { data, error } = await supabaseClient
                .from('user_settings')
                .select('setting_value')
                .eq('user_id', currentUserId)
                .eq('setting_key', key)
                .single();

            if (error && error.code !== 'PGRST116') {
                console.error("Error fetching user setting from Supabase:", error);
                throw error;
            }

            return data ? data.setting_value : null;
        }

        // Adaptada para usar Supabase
        async function setUserSetting(key, value) {
            if (!currentUserId) {
                console.warn('Intentando guardar setting sin ID de usuario. Fallo.');
                return;
            }

            const dataToStore = {
                user_id: currentUserId,
                setting_key: key,
                setting_value: value
            };

            // Upsert: intenta insertar, si ya existe, actualiza
            const { error } = await supabaseClient
                .from('user_settings')
                .upsert(dataToStore, { onConflict: 'user_id,setting_key' });

            if (error) {
                console.error("Error saving user setting to Supabase:", error);
                throw error;
            }
        }

        async function loadOrCreateUserId() {
            // currentUserId ya se ha establecido en initializeApp desde la sesión de Supabase
            if (currentUserId) {
                document.getElementById('currentUserId').textContent = currentUserId;
                document.getElementById('userIdContainer').style.display = 'flex';
                console.log("Loaded Supabase user ID:", currentUserId);
            } else {
                console.error("loadOrCreateUserId llamado sin un usuario Supabase autenticado. Redirigiendo.");
                showNotification("Error interno. Redirigiendo...", 'error', true);
                setTimeout(() => window.location.href = REDIRECT_LOGIN_URL, 1000);
            }
        }

        async function loadOrCreateCollectionShareCode() {
            if (!currentUserId) {
                console.warn('Intentando cargar/crear collectionShareCode sin ID de usuario. Fallo.');
                return;
            }
            let code = await getUserSetting('collectionShareCode');
            if (!code) {
                let isUniqueCollectionCode = false;
                let generatedCode = '';
                const maxRetries = 100;

                for (let i = 0; i < maxRetries && !isUniqueCollectionCode; i++) {
                    generatedCode = Math.floor(1000000000 + Math.random() * 9000000000).toString();
                    // Verificar que no coincida con ningun share_code de entrada (globalmente)
                    const { data, error } = await supabaseClient
                        .from('entries')
                        .select('share_code')
                        .eq('share_code', generatedCode)
                        .single();
                    
                    if (error && error.code === 'PGRST116') { // No row found, code is unique
                        isUniqueCollectionCode = true;
                    } else if (!error && data) { // Found a row, code is not unique
                        isUniqueCollectionCode = false;
                    } else { // Other errors
                        console.error("Error checking collectionShareCode uniqueness on Supabase:", error);
                        isUniqueCollectionCode = false;
                    }
                }
                
                await setUserSetting('collectionShareCode', generatedCode);
                code = generatedCode;
                console.log("Generated new collection share code:", code);
            } else {
                console.log("Loaded existing collection share code:", code);
            }
            collectionShareCode = code;
        }

        async function resetCollectionShareCode() {
            if (!currentUserId) return;
            await setUserSetting('collectionShareCode', null);
            await loadOrCreateCollectionShareCode();
        }
        
        function toggleUserIdVisibility() {
            const userIdContainer = document.getElementById('userIdContainer');
            const userIdToggleButton = document.getElementById('userIdToggleButton');

            isUserIdPanelActive = !isUserIdPanelActive;

            if (isUserIdPanelActive) {
                userIdContainer.classList.add('active');
                userIdToggleButton.innerHTML = '<i class="fas fa-angle-right"></i>';
            } else {
                userIdContainer.classList.remove('active');
                userIdToggleButton.innerHTML = '<i class="fas fa-angle-left"></i>';
            }
        }

        function copyUserIdToClipboard() {
            if (!currentUserId) {
                return showNotification('No hay ID de usuario para copiar', 'warning');
            }
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(currentUserId)
                        .then(() => {
                            showNotification('ID de Usuario copiado al portapapeles', 'success');
                        })
                        .catch(err => {
                            console.error('Error al copiar el ID de usuario usando la API del Portapapeles:', err);
                            copyTextToClipboardLegacy(currentUserId);
                        });
                } else {
                    copyTextToClipboardLegacy(currentUserId);
                }
            } catch (error) {
                console.error('Error al copiar el ID de usuario:', error);
                showNotification('Error al copiar el ID de usuario', 'error');
            }
        }


        async function loadEntries() {
            try {
                const entries = await getEntries(); 
                const filteredEntries = filterEntries(entries);
                renderEntries(filteredEntries);
            } catch (error) {
                console.error('Error al cargar las entradas:', error);
                showNotification('Error al cargar las entradas', 'error');
            }
        }

        function filterEntries(entries) {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = entries.filter(entry => {
                const matchesSearch = entry.name.toLowerCase().includes(searchTerm) ||
                                      (entry.description && entry.description.toLowerCase().includes(searchTerm)) ||
                                      (entry.tags && entry.tags.some(tag => tag.toLowerCase().includes(searchTerm)));

                let matchesCategory;
                if (categoryFilter === 'favorites') {
                    matchesCategory = entry.isFavorite;
                } else if (categoryFilter) {
                    matchesCategory = entry.category === categoryFilter;
                } else {
                    matchesCategory = true;
                }

                return matchesSearch && matchesCategory;
            });

            switch (sortBy) {
                case 'newest': filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); break; // Usar created_at de Supabase
                case 'oldest': filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at)); break;
                case 'name': filtered.sort((a, b) => a.name.localeCompare(b.name)); break;
                case 'category': filtered.sort((a, b) => a.category.localeCompare(b.category)); break;
                case 'favorites': filtered.sort((a, b) => (b.isFavorite || 0) - (a.isFavorite || 0)); break;
                case 'mostClicked': filtered.sort((a, b) => (b.clickCount || 0) - (a.clickCount || 0)); break;
            }
            return filtered;
        }


        function renderEntries(entries) {
            const grid = document.getElementById('cardsGrid');
            const emptyState = document.getElementById('emptyState');
            if (entries.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                grid.style.display = 'grid';
                emptyState.style.display = 'none';
                grid.innerHTML = entries.map(entry => createCardHTML(entry)).join('');
            }
        }

        function createCardHTML(entry) {
            const displayCategory = categories[entry.category] || categories.other;
            const lastOpenedDate = entry.lastOpened ? `Abierto: ${new Date(entry.lastOpened).toLocaleDateString()}` : 'Nunca abierto';
            const cardColorStyle = entry.cardColor ? `border-left-color: ${entry.cardColor};` : '';

            return `
                <div class="mining-card fade-in" style="${cardColorStyle}">
                    <div class="card-image-container">
                        <img src="${entry.image}" alt="${escapeHtml(entry.name)}" class="card-image" loading="lazy">
                        <div class="card-top-actions">
                            <button class="card-top-btn favorite-btn ${entry.isFavorite ? 'is-favorite' : ''}" onclick="toggleFavorite('${entry.id}')" data-tooltip="Favorito">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="card-top-btn" onclick="openShareModal('${entry.id}')" data-tooltip="Compartir">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button class="card-top-btn" onclick="exportIndividualEntry('${entry.id}')" data-tooltip="Exportar JSON">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="status-dot ${entry.status || 'active'}" data-tooltip="Estado: ${entry.status || 'activo'}"></span>
                                ${escapeHtml(entry.name)}
                            </h3>
                            <div class="category-badge category-${displayCategory.name.toLowerCase().replace(/\s/g, '')}">
                                <i class="${displayCategory.icon}"></i>
                                ${displayCategory.name}
                            </div>
                        </div>
                        
                        ${entry.description ? `<p class="text-gray-400 text-sm mb-3">${escapeHtml(entry.description)}</p>` : ''}
                        ${entry.url ? `<div class="card-url mb-3"><i class="fas fa-link mr-1"></i>${escapeHtml(entry.url)}</div>` : ''}
                        
                        <div class="card-actions">
                            <button class="btn btn-primary flex-1" onclick="openMiningPage('${entry.id}')"><i class="fas fa-play"></i>Abrir</button>
                            <div class="flex gap-1">
                                <button class="btn btn-secondary btn-small" onclick="copyUrlToClipboard('${entry.id}')" data-tooltip="Copiar URL"><i class="fas fa-copy"></i></button>
                                <button class="btn btn-warning btn-small" onclick="editEntry('${entry.id}')" data-tooltip="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger btn-small" onclick="showDeleteConfirmation('${entry.id}')" data-tooltip="Eliminar"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span class="card-stat" data-tooltip="Veces abierto"><i class="fas fa-mouse-pointer"></i> ${entry.clickCount || 0}</span>
                        <span class="card-stat" data-tooltip="脷ltima apertura"><i class="fas fa-clock"></i> ${lastOpenedDate}</span>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) { 
            if (text === null || text === undefined) return ''; 
            const div = document.createElement('div'); 
            div.textContent = text; 
            return div.innerHTML; 
        }

        async function exportIndividualEntry(id) {
            try {
                const entry = await getEntryById(id);
                if (!entry) return showNotification('Entrada no encontrada o no tienes permiso para exportarla', 'error');

                const exportEntry = { ...entry };
                if (exportEntry.isFavorite && exportEntry.originalCategory) {
                    exportEntry.category = exportEntry.originalCategory;
                    delete exportEntry.originalCategory;
                }
                // Eliminar campos internos de Supabase para la exportación
                delete exportEntry.user_id; 
                delete exportEntry.created_at;
                delete exportEntry.updated_at;
                // Adaptar nombres de vuelta al formato original si es necesario para el JSON exportado
                exportEntry.isFavorite = exportEntry.is_favorite; delete exportEntry.is_favorite;
                exportEntry.clickCount = exportEntry.click_count; delete exportEntry.click_count;
                exportEntry.lastOpened = exportEntry.last_opened; delete exportEntry.last_opened;
                exportEntry.cardColor = exportEntry.card_color; delete exportEntry.card_color;
                exportEntry.shareCode = exportEntry.share_code; delete exportEntry.share_code;
                delete exportEntry.ownerId; // Eliminar el campo interno

                const exportData = { version: '1.8.0', exportDate: new Date().toISOString(), exportType: 'individual', totalEntries: 1, entries: [exportEntry] };
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const sanitizedName = entry.name.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50);
                link.download = `lunaria-entry-${sanitizedName}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification(`Entrada "${entry.name}" exportada (JSON)`, 'success');
            } catch (error) {
                console.error('Error al exportar entrada individual:', error);
                showNotification('Error al exportar la entrada', 'error');
            }
        }

        function openAddModal() {
            editingEntry = null;
            document.getElementById('modalTitle').textContent = 'Agregar Entrada';
            document.getElementById('saveButtonText').textContent = 'Guardar';
            document.getElementById('miningForm').reset();
            document.getElementById('imagePreview').src = 'https://i.postimg.cc/GpPsSmmX/4491470.png';
            document.getElementById('cardColorInput').value = '#0ea5e9';
            clearErrors();
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() { document.getElementById('addModal').classList.remove('active'); editingEntry = null; clearErrors(); }

        function openAddUrlModal() {
            document.getElementById('addUrlForm').reset();
            document.getElementById('shareCodeInputError').textContent = '';
            document.getElementById('addUrlModal').classList.add('active');
        }

        function closeAddUrlModal() {
            document.getElementById('addUrlModal').classList.remove('active');
            document.getElementById('shareCodeInput').value = '';
            document.getElementById('shareCodeInputError').textContent = '';
        }

        document.getElementById('addUrlForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const shareCode = document.getElementById('shareCodeInput').value.trim();
            const errorDisplay = document.getElementById('shareCodeInputError');
            errorDisplay.textContent = '';

            if (!shareCode) {
                errorDisplay.textContent = 'El codigo es obligatorio.';
                return;
            }
            if (!/^\d{10}$/.test(shareCode)) {
                errorDisplay.textContent = 'El codigo debe ser num茅rico y de 10 digitos.';
                return;
            }

            try {
                if (shareCode === collectionShareCode) {
                    showNotification('Este es un codigo de colección. La importación de colecciones se integrar en futuras actualizaciones con Supabase.', 'info', true);
                    closeAddUrlModal();
                    return;
                }

                // Buscar la entrada por share_code usando la función RPC
                const foundEntry = await findEntryByShareCode(shareCode);

                if (foundEntry) {
                    // Verificar si el usuario ya tiene una tarjeta con esa URL y nombre
                    const existingEntryForCurrentUser = await findEntryByNameAndUrl(foundEntry.name, foundEntry.url);
                    if (existingEntryForCurrentUser) {
                        showNotification('La tarjeta con este nombre y URL ya existe para ti y no fue agregada.', 'info');
                        closeAddUrlModal();
                        return;
                    }
                    
                    // Intentar integrar la tarjeta como si fuera nueva para el usuario actual
                    // No necesitamos el ownerId del original, solo los datos de la tarjeta.
                    const result = await integrateSingleCard({
                        name: foundEntry.name,
                        category: foundEntry.category,
                        url: foundEntry.url,
                        description: foundEntry.description,
                        tags: foundEntry.tags,
                        image: foundEntry.image,
                        status: foundEntry.status,
                        cardColor: foundEntry.cardColor,
                        // No pasar el shareCode original aqui. integrateSingleCard generar uno nuevo.
                    });

                    if (result === 'added') {
                        showNotification('Tarjeta integrada con Exito', 'success');
                    } else if (result === 'duplicate') { // Esta ruta ya deberia ser manejada arriba, pero por seguridad
                        showNotification('La tarjeta con este nombre y URL ya existe para ti y no fue agregada.', 'info');
                    }
                } else {
                    showNotification('No se encontre una tarjeta con este codigo.', 'warning', true);
                }
                
                await loadEntries();
                updateStats();
                updateUsageCharts();

                closeAddUrlModal();

            } catch (error) {
                console.error('Error al procesar el codigo numerico:', error);
                errorDisplay.textContent = `Error al integrar la tarjeta: ${error.message}.`;
                showNotification(`Error al integrar la tarjeta: ${error.message}`, "error");
            }
        });

        async function integrateSingleCard(cardData) {
            if (!currentUserId) {
                throw new Error('No se puede integrar la tarjeta sin un ID de usuario.');
            }
            if (!cardData.name || !cardData.category || !validateCategory(cardData.category)) {
                throw new Error('La tarjeta es invalida (falta nombre o categoria valida).');
            }

            // Verificar duplicados para el usuario actual antes de integrar
            if (cardData.name && cardData.url && isValidUrl(cardData.url)) {
                const existingEntryForCurrentUser = await findEntryByNameAndUrl(cardData.name, cardData.url);
                if (existingEntryForCurrentUser) {
                    console.log(`Tarjeta duplicada detectada para el usuario actual: "${cardData.name}" con URL "${cardData.url}". No se agregar谩.`);
                    return 'duplicate';
                }
            }
            
            const newEntry = {
                name: cardData.name,
                category: cardData.category,
                url: cardData.url,
                description: cardData.description || '',
                tags: Array.isArray(cardData.tags) ? cardData.tags : [],
                image: cardData.image || 'https://i.postimg.cc/GpPsSmmX/4491470.png',
                isFavorite: false, // Las tarjetas importadas no son favoritas por defecto
                clickCount: 0,
                lastOpened: null,
                status: cardData.status || 'active',
                cardColor: cardData.cardColor || '#0ea5e9',
                shareCode: await generateUniqueShareCode() // SIEMPRE generar un nuevo shareCode para la tarjeta importada
            };

            const savedEntry = await saveEntry(newEntry);
            if (savedEntry) {
                return 'added';
            }
            return 'error';
        }


        async function editEntry(id) {
            try {
                const entry = await getEntryById(id);
                if (!entry) return showNotification('Entrada no encontrada o no tienes permiso para editarla', 'error');
                editingEntry = entry;
                document.getElementById('modalTitle').textContent = 'Editar Entrada';
                document.getElementById('saveButtonText').textContent = 'Actualizar';
                document.getElementById('nameInput').value = entry.name;
                document.getElementById('categoryInput').value = entry.category; 
                document.getElementById('urlInput').value = entry.url || '';
                document.getElementById('descriptionInput').value = entry.description || '';
                document.getElementById('tagsInput').value = entry.tags ? entry.tags.join(', ') : '';
                document.getElementById('imagePreview').src = entry.image;
                document.getElementById('statusInput').value = entry.status || 'active';
                document.getElementById('cardColorInput').value = entry.cardColor || '#0ea5e9';
                clearErrors();
                document.getElementById('addModal').classList.add('active');
            } catch (error) {
                console.error('Error al cargar la entrada para editar:', error);
                showNotification('Error al cargar la entrada', 'error');
            }
        }

        function showDeleteConfirmation(id) {
            confirmCallback = () => performDelete(id);
            document.getElementById('confirmMessage').textContent = 'Estas seguro de que deseas eliminar esta entrada? Esta acción no se puede deshacer.';
            document.getElementById('confirmActionButton').innerHTML = '<i class="fas fa-check"></i> Confirmar';
            document.getElementById('confirmModal').classList.add('active');
        }
        
        function showDeleteAllConfirmation() {
            confirmCallback = () => performDeleteAll();
            document.getElementById('confirmMessage').textContent = 'Estas seguro de que deseas formatear la aplicacion? Se borraran todas las entradas de forma permanente.';
            document.getElementById('confirmActionButton').innerHTML = '<i class="fas fa-trash-alt"></i> Formatear';
            document.getElementById('confirmModal').classList.add('active');
        }

        async function performDelete(id) {
            try {
                await deleteEntry(id);
                await loadEntries();
                updateStats();
                updateUsageCharts();
                showNotification('Entrada eliminada', 'success');
                closeConfirmModal();
            } catch (error) {
                console.error('Error al eliminar la entrada:', error);
                showNotification('Error al eliminar la entrada', 'error');
            }
        }
        
        async function performDeleteAll() {
            if (!currentUserId) {
                showNotification('Error: No se puede formatear sin un usuario autenticado.', 'error');
                return;
            }

            try {
                // Eliminar todas las entradas del usuario actual
                const { error: entriesError } = await supabaseClient
                    .from('entries')
                    .delete()
                    .eq('user_id', currentUserId);
                if (entriesError) throw entriesError;

                // Eliminar todas las entradas de page_usage del usuario actual
                const { error: pageUsageError } = await supabaseClient
                    .from('page_usage')
                    .delete()
                    .eq('user_id', currentUserId);
                if (pageUsageError) throw pageUsageError;

                // Eliminar todas las entradas de category_usage del usuario actual
                const { error: categoryUsageError } = await supabaseClient
                    .from('category_usage')
                    .delete()
                    .eq('user_id', currentUserId);
                if (categoryUsageError) throw categoryUsageError;
                
                // Eliminar los settings especificos del usuario (collectionShareCode)
                const { error: settingsError } = await supabaseClient
                    .from('user_settings')
                    .delete()
                    .eq('user_id', currentUserId)
                    .eq('setting_key', 'collectionShareCode'); // Especificar la clave del setting a borrar
                if (settingsError) throw settingsError;

                await loadEntries(); 
                updateStats();
                updateUsageCharts();
                
                collectionShareCode = null; 
                await loadOrCreateCollectionShareCode(); 
                
                showNotification('Todos tus datos han sido borrados de esta aplicacion.', 'success');
                closeConfirmModal();
            } catch (error) {
                console.error('Error al borrar todos los datos del usuario:', error);
                showNotification('Error al borrar todos tus datos', 'error');
            }
        }

        function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('active'); confirmCallback = null; document.getElementById('confirmActionButton').innerHTML = '<i class="fas fa-check"></i> Confirmar'; }
        function confirmAction() { if (confirmCallback) confirmCallback(); }

        document.getElementById('miningForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('nameInput').value.trim();
            const category = document.getElementById('categoryInput').value;
            const url = document.getElementById('urlInput').value.trim();
            
            if (!validateForm(name, category, url)) return;
            
            try {
                const isExistingEntry = !!editingEntry;

                if (!isExistingEntry && name && url) {
                    const existingEntryByNameAndUrl = await findEntryByNameAndUrl(name, url);
                    if (existingEntryByNameAndUrl) {
                        showNotification('Ya existe una tarjeta con este nombre y URL base (ignorando referencias numericas) para ti.', 'warning');
                        return;
                    }
                }

                const entry = {
                    id: isExistingEntry ? editingEntry.id : undefined, // Supabase generar UUID si es undefined
                    name: name,
                    category: category, 
                    url: url,
                    description: document.getElementById('descriptionInput').value.trim(),
                    tags: document.getElementById('tagsInput').value.trim() ? document.getElementById('tagsInput').value.trim().split(',').map(tag => tag.trim()).filter(tag => tag) : [],
                    image: document.getElementById('imagePreview').src,
                    // created_at y updated_at se gestionan automaticamente por Supabase al insertar/actualizar
                    isFavorite: isExistingEntry ? editingEntry.isFavorite : false,
                    clickCount: isExistingEntry ? editingEntry.clickCount || 0 : 0,
                    lastOpened: isExistingEntry ? editingEntry.lastOpened : null,
                    status: document.getElementById('statusInput').value,
                    cardColor: document.getElementById('cardColorInput').value,
                    shareCode: isExistingEntry && editingEntry.shareCode ? editingEntry.shareCode : await generateUniqueShareCode(),
                };

                if (isExistingEntry && editingEntry.isFavorite) {
                    if (category !== 'favorites' && editingEntry.category === 'favorites') {
                         entry.isFavorite = false;
                         entry.originalCategory = undefined;
                    } else if (category === 'favorites' && editingEntry.originalCategory) {
                        entry.originalCategory = editingEntry.originalCategory;
                    }
                } else {
                    entry.originalCategory = undefined;
                }

                await saveEntry(entry);
                await loadEntries();
                updateStats();
                updateUsageCharts();
                showNotification(isExistingEntry ? 'Entrada actualizada' : 'Entrada guardada!', 'success');
                closeAddModal();
            } catch (error) {
                console.error('Error al guardar la entrada:', error);
                showNotification('Error al guardar la entrada', 'error');
            }
        });

        function validateForm(name, category, url) { 
            clearErrors(); 
            let isValid = true; 
            if (!name) { 
                showFieldError('nameError', 'El nombre es obligatorio'); 
                isValid = false; 
            } else if (name.length > 100) { 
                showFieldError('nameError', 'El nombre no puede exceder 100 caracteres'); 
                isValid = false; 
            } 
            if (!category || !Object.keys(categories).includes(category)) { 
                showFieldError('categoryError', 'La categoria es obligatoria y valida'); 
                isValid = false; 
            } 
            if (url && !isValidUrl(url)) { 
                showFieldError('urlError', 'Por favor, proporciona una URL valida'); 
                isValid = false; 
            } 
            return isValid; 
        }
        function showFieldError(elementId, message) { document.getElementById(elementId).textContent = message; }
        function clearErrors() { document.getElementById('nameError').textContent = ''; document.getElementById('categoryError').textContent = ''; document.getElementById('urlError').textContent = ''; }
        function isValidUrl(string) { try { new URL(string); return true; } catch (_) { return false; } }

        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!['image/jpeg', 'image/png', 'image/gif', 'image/webp'].includes(file.type)) {
                return showNotification('Formato de imagen no soportado. Usa JPG, PNG, GIF o WebP.', 'error');
            }
            if (file.size > 10 * 1024 * 1024) {
                return showNotification('La imagen es demasiado grande (Max 10MB)', 'error');
            }
            try {
                const compressedImage = await compressImage(file);
                document.getElementById('imagePreview').src = compressedImage;
            } catch (error) {
                console.error('Error al procesar la imagen:', error);
                showNotification('Error al procesar la imagen', 'error');
            }
        }

        function compressImage(file) { 
            return new Promise((resolve, reject) => { 
                const reader = new FileReader(); 
                reader.onload = (event) => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        const canvas = document.createElement('canvas'); 
                        const ctx = canvas.getContext('2d'); 
                        const maxWidth = 800, maxHeight = 600; 
                        let { width, height } = img; 
                        if (width > height) { 
                            if (width > maxWidth) { 
                                height = (height * maxWidth) / width; 
                                width = maxWidth; 
                            } 
                        } else { 
                            if (height > maxHeight) { 
                                width = (width * maxHeight) / height; 
                                height = maxHeight; 
                            } 
                        } 
                        canvas.width = width; 
                        canvas.height = height; 
                        ctx.drawImage(img, 0, 0, width, height); 
                        resolve(canvas.toDataURL('image/jpeg', 0.8)); 
                    }; 
                    img.onerror = reject; 
                    img.src = event.target.result; 
                }; 
                reader.onerror = reject; 
                reader.readAsDataURL(file); 
            }); 
        }

        async function updateStats() {
            try {
                const entries = await getEntries();
                const uniqueCategories = [...new Set(entries.filter(e => e.category !== 'favorites').map(entry => entry.category))];
                const favoriteEntries = entries.filter(entry => entry.isFavorite);
                const totalClicks = entries.reduce((sum, entry) => sum + (entry.clickCount || 0), 0);

                document.getElementById('totalEntries').textContent = entries.length;
                document.getElementById('totalCategories').textContent = uniqueCategories.length;
                document.getElementById('favoriteEntries').textContent = favoriteEntries.length;
                document.getElementById('totalClicks').textContent = totalClicks;
            } catch (error) {
                console.error('Error al actualizar estadisticas:', error);
            }
        }

        async function updateUsageCharts() { 
            await updatePageUsageChart(); 
            await updateCategoryUsageChart(); 
        }

        async function updatePageUsageChart() {
            try {
                const pageStats = await getPageUsageStats(); 
                const sortedStats = pageStats.sort((a, b) => b.count - a.count).slice(0, 10);
                const labels = sortedStats.map(s => s.name || s.url);
                const data = sortedStats.map(s => s.count);

                if (pageUsageChart) {
                    pageUsageChart.destroy();
                }

                const ctx = document.getElementById('pageUsageChart').getContext('2d');
                pageUsageChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Veces Abierta',
                            data: data,
                            backgroundColor: barColors.slice(0, labels.length),
                            borderColor: barColors.slice(0, labels.length).map(color => color.replace('0.8', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }
                            },
                            y: {
                                ticks: { color: getComputedStyle(document.body).getPropertyValue('--text-secondary') }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw}`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al actualizar la grafica de uso de paginas', error);
                showNotification('Error al cargar la grafica de uso de paginas', 'error');
            }
        }

        async function updateCategoryUsageChart() {
            try {
                const categoryStats = await getCategoryUsageStats(); 
                const filteredCategoryStats = categoryStats.filter(s => s.category !== 'favorites');
                const sortedStats = filteredCategoryStats.sort((a, b) => b.count - a.count).slice(0, 10);
                const labels = sortedStats.map(s => categories[s.category]?.name || s.name);
                const data = sortedStats.map(s => s.count);

                if (categoryUsageChart) {
                    categoryUsageChart.destroy();
                }

                const ctx = document.getElementById('categoryUsageChart').getContext('2d');
                categoryUsageChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Veces Usada',
                            data: data,
                            backgroundColor: barColors.slice(0, labels.length),
                            borderColor: getComputedStyle(document.body).getPropertyValue('--card-bg'),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: getComputedStyle(document.body).getPropertyValue('--text-primary')
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let sum = 0;
                                        let dataArr = context.dataset.data;
                                        dataArr.map(data => { sum += data; });
                                        let percentage = (context.raw * 100 / sum).toFixed(2) + '%';
                                        return `${context.label}: ${context.raw} (${percentage})`;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error al actualizar la grafica de uso de categorias:', error);
                showNotification('Error al cargar la grafica de uso de categorias', 'error');
            }
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(loadEntries, 300));
            document.getElementById('categoryFilter').addEventListener('change', function() { 
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                const activeChip = document.querySelector(`.filter-chip[data-category="${this.value}"]`);
                if (activeChip) activeChip.classList.add('active');
                
                loadEntries(); 
                if (this.value && this.value !== 'favorites') {
                    trackCategoryUsage(this.value);
                }
            });
            document.getElementById('sortBy').addEventListener('change', loadEntries);

            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    const category = this.dataset.category;
                    document.getElementById('categoryFilter').value = category;
                    loadEntries();
                    if (category && category !== 'favorites') {
                       trackCategoryUsage(category);
                    }
                });
            });
        }

        function toggleTheme() { 
            const body = document.body; 
            const themeIcon = document.getElementById('themeIconMenu');
            if (body.dataset.theme === 'dark') { 
                body.dataset.theme = 'light'; 
                themeIcon.className = 'fas fa-sun'; 
                localStorage.setItem('theme', 'light'); 
            } else { 
                body.dataset.theme = 'dark'; 
                themeIcon.className = 'fas fa-moon'; 
                localStorage.setItem('theme', 'dark'); 
            } 
            setTimeout(updateUsageCharts, 100); 
        }

        function loadTheme() { 
            const savedTheme = localStorage.getItem('theme') || 'dark'; 
            const body = document.body; 
            const themeIconMenu = document.getElementById('themeIconMenu');
            body.dataset.theme = savedTheme; 
            if (themeIconMenu) themeIconMenu.className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        function openExportModal() { document.getElementById('exportModal').classList.add('active'); }
        function closeExportModal() { document.getElementById('exportModal').classList.remove('active'); hideImportProgress(); }
        function showImportProgress() { document.getElementById('importProgress').classList.add('show'); }
        function hideImportProgress() { document.getElementById('importProgress').classList.remove('show'); document.getElementById('importLog').innerHTML = ''; document.getElementById('importProgressBar').style.width = '0%'; }
        function updateImportProgress(progress, message, type = 'info') { 
            document.getElementById('importProgressBar').style.width = `${progress}%`; 
            const log = document.getElementById('importLog'); 
            const logEntry = document.createElement('div'); 
            logEntry.className = type; 
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`; 
            log.appendChild(logEntry); 
            log.scrollTop = log.scrollHeight;
        }

        async function exportData() {
            try {
                const entries = await getEntries(); 
                const exportableEntries = entries.map(entry => {
                    const entryCopy = { ...entry };
                    if (entryCopy.isFavorite && entryCopy.originalCategory) {
                        entryCopy.category = entryCopy.originalCategory;
                        delete entryCopy.originalCategory;
                    }
                    // Eliminar campos internos de Supabase para la exportación
                    delete entryCopy.user_id; 
                    delete entryCopy.created_at;
                    delete entryCopy.updated_at;
                    // Adaptar nombres de vuelta al formato original si es necesario para el JSON exportado
                    entryCopy.isFavorite = entryCopy.is_favorite; delete entryCopy.is_favorite;
                    entryCopy.clickCount = entryCopy.click_count; delete entryCopy.click_count;
                    entryCopy.lastOpened = entryCopy.last_opened; delete entryCopy.last_opened;
                    entryCopy.cardColor = entryCopy.card_color; delete entryCopy.card_color;
                    entryCopy.shareCode = entryCopy.share_code; delete entryCopy.share_code;
                    delete entryCopy.ownerId; // Eliminar el campo interno
                    return entryCopy;
                });

                const exportData = { version: '1.8.0', exportDate: new Date().toISOString(), totalEntries: exportableEntries.length, entries: exportableEntries };
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const sanitizedName = "lunaria-mining-data"; 
                link.download = `${sanitizedName}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('Datos exportados como JSON', 'success');
            } catch (error) {
                console.error('Error al exportar datos:', error);
                showNotification('Error al exportar datos como JSON', 'error');
            }
        }

        async function exportCSV() {
            try {
                const entries = await getEntries(); 
                if (entries.length === 0) {
                    return showNotification('No hay datos para exportar a CSV', 'warning');
                }
                const exportableEntries = entries.map(entry => {
                    const entryCopy = { ...entry };
                    if (entryCopy.isFavorite && entryCopy.originalCategory) {
                        entryCopy.category = entryCopy.originalCategory;
                        delete entryCopy.originalCategory;
                    }
                    // Eliminar campos internos de Supabase para la exportaci贸n
                    delete entryCopy.user_id; 
                    delete entryCopy.created_at;
                    delete entryCopy.updated_at;
                    // Adaptar nombres de vuelta al formato original si es necesario para el JSON exportado
                    entryCopy.isFavorite = entryCopy.is_favorite; delete entryCopy.is_favorite;
                    entryCopy.clickCount = entryCopy.click_count; delete entryCopy.click_count;
                    entryCopy.lastOpened = entryCopy.last_opened; delete entryCopy.last_opened;
                    entryCopy.cardColor = entryCopy.card_color; delete entryCopy.card_color;
                    entryCopy.shareCode = entryCopy.share_code; delete entryCopy.share_code;
                    delete entryCopy.ownerId; // Eliminar el campo interno
                    return entryCopy;
                });

                const headers = ["id", "name", "category", "url", "description", "tags", "image", "isFavorite", "clickCount", "lastOpened", "status", "cardColor", "shareCode"];
                let csv = headers.join(',') + '\n';

                exportableEntries.forEach(entry => {
                    const row = headers.map(header => {
                        let value = entry[header];
                        if (header === 'tags' && Array.isArray(value)) {
                            value = value.join(';');
                        } else if (typeof value === 'boolean') {
                            value = value ? 'true' : 'false';
                        }
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                            value = `"${value.replace(/"/g, '""')}"`;
                        }
                        return value !== undefined && value !== null ? value : '';
                    }).join(',');
                    csv += row + '\n';
                });

                const dataBlob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `lunaria-mining-data-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('Datos exportados como CSV', 'success');
            } catch (error) {
                console.error('Error al exportar CSV:', error);
                showNotification('Error al exportar datos como CSV', 'error');
            }
        }

        async function importData(fileToImport = null) {
            let file;
            if (fileToImport) {
                file = fileToImport;
            } else {
                const input = document.getElementById('importFile');
                file = input.files[0];
            }

            if (!file) {
                return showNotification('Por favor, selecciona un archivo para importar', 'warning');
            }

            showImportProgress();
            updateImportProgress(0, 'Iniciando importaci贸n...');

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    let importedEntries = [];
                    if (file.type === 'application/json' || file.name.endsWith('.json')) {
                        updateImportProgress(20, 'Analizando archivo JSON...');
                        importedEntries = await parseJSONFile(text);
                    } else if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        updateImportProgress(20, 'Analizando archivo CSV...');
                        importedEntries = await parseCSVFile(text);
                    } else {
                        updateImportProgress(100, `Formato de archivo no soportado: ${file.type}`, 'error');
                        return showNotification('Formato de archivo no soportado. Usa JSON o CSV.', 'error');
                    }

                    if (!importedEntries || importedEntries.length === 0) {
                        updateImportProgress(100, 'No se encontraron entradas validas en el archivo.', 'warning');
                        return showNotification('No se importaron entradas validas.', 'warning');
                    }

                    updateImportProgress(50, `Importando ${importedEntries.length} entradas...`);
                    let successCount = 0;
                    let errorCount = 0;
                    let duplicateCount = 0;
                    for (let i = 0; i < importedEntries.length; i++) {
                        const entry = importedEntries[i];
                        try {
                            const result = await integrateSingleCard(entry);
                            if (result === 'added') {
                                successCount++;
                                updateImportProgress(50 + (i / importedEntries.length * 40), `Importado: "${entry.name || 'Sin Nombre'}"`, 'info');
                            } else if (result === 'duplicate') {
                                duplicateCount++;
                                updateImportProgress(50 + (i / importedEntries.length * 40), `Duplicado: "${entry.name || 'Sin Nombre'}" ya existe para ti.`, 'warning');
                            }
                        } catch (saveError) {
                            errorCount++;
                            updateImportProgress(50 + (i / importedEntries.length * 40), `Error al guardar "${entry.name || 'Sin Nombre'}": ${saveError.message}`, 'error');
                            console.error('Error al guardar la entrada importada:', entry, saveError);
                        }
                    }

                    updateImportProgress(100, `Importación completada. Exito: ${successCount}, Duplicados: ${duplicateCount}, Errores: ${errorCount}.`, successCount > 0 || duplicateCount > 0 ? 'success' : errorCount > 0 ? 'error' : 'warning');
                    await loadEntries();
                    updateStats();
                    updateUsageCharts();
                    showNotification(`Importaci贸n finalizada: ${successCount} entradas importadas, ${duplicateCount} duplicados omitidos.`, successCount > 0 || duplicateCount > 0 ? 'success' : 'warning');
                };
                reader.onerror = (e) => {
                    updateImportProgress(100, `Error de lectura del archivo: ${e.target.error.message}`, 'error');
                    showNotification(`Error de lectura del archivo: ${e.target.error.message}`, 'error');
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error durante el proceso de importación:', error);
                updateImportProgress(100, `Error fatal durante la importación: ${error.message}`, 'error');
                showNotification(`Error durante la importación: ${error.message}`, 'error');
            }
        }

        async function parseJSONFile(text) {
            try {
                const data = JSON.parse(text);
                if (typeof data === 'object' && data !== null && !Array.isArray(data)) {
                    if (data.entries && Array.isArray(data.entries)) {
                        return data.entries;
                    }
                    return [data];
                } else if (Array.isArray(data)) {
                    return data;
                }
                return [];
            } catch (error) {
                console.error('Error al analizar archivo JSON:', error);
                throw new Error('Formato JSON invalido.');
            }
        }


        async function parseCSVFile(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];

            const headers = parseCSVLine(lines[0]);
            const entries = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length !== headers.length) {
                    console.warn(`Saltando linea CSV mal formada ${i + 1}: ${lines[i]}`);
                    continue;
                }
                const entry = {};
                headers.forEach((header, index) => {
                    let value = values[index];
                    if (header === 'tags' && Array.isArray(value)) { // Verificar si `value` es un array antes de `.join`
                        entry[header] = value ? value.split(';').map(tag => tag.trim()) : [];
                    } else if (header === 'isFavorite') {
                        entry[header] = value === 'true';
                    } else if (header === 'clickCount') {
                        entry[header] = parseInt(value) || 0;
                    } else {
                        entry[header] = value;
                    }
                });
                // Adaptar nombres de columnas de nuevo
                entry.is_favorite = entry.isFavorite; delete entry.isFavorite;
                entry.click_count = entry.clickCount; delete entry.clickCount;
                entry.last_opened = entry.lastOpened; delete entry.lastOpened;
                entry.card_color = entry.cardColor; delete entry.cardColor;
                entry.share_code = entry.shareCode; delete entry.shareCode;

                entries.push(entry);
            }
            return entries;
        }

        function parseCSVLine(line) {
            const result = [];
            let inQuote = false;
            let currentField = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuote && i + 1 < line.length && line[i + 1] === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    result.push(currentField);
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            result.push(currentField);
            return result;
        }

        function validateCategory(category) {
            return Object.keys(categories).includes(category);
        }

        function openExternalUrl(url) {
            if (url) {
                window.open(url, '_blank');
                showNotification('Pagina abierta en una nueva pestaña externa.', 'info');
            } else {
                showNotification('No hay URL disponible para abrir externamente.', 'warning');
            }
        }

        async function openMiningPage(id) {
            try {
                const entry = await getEntryById(id); 
                if (!entry || !entry.url) return showNotification('URL no disponible para esta entrada', 'error');
                
                entry.clickCount = (entry.clickCount || 0) + 1;
                entry.lastOpened = new Date().toISOString();
                await saveEntry(entry); // saveEntry ya asigna user_id
                
                window.open(entry.url, '_blank');
                showNotification(`Abriendo "${entry.name}" en una nueva pestaña.`, 'info');
                
                if (entry.isFavorite && entry.originalCategory) {
                    trackCategoryUsage(entry.originalCategory);
                } else {
                    trackCategoryUsage(entry.category);
                }
                trackPageUsage(entry.url, entry.name);
                
                loadEntries();
                updateStats();
            } catch (error) {
                console.error('Error al abrir la pagina de mineria:', error);
                showNotification('Error al abrir la pagina. Verifica la URL.', 'error');
            }
        }

        function generateUniqueEntryId() { 
            // Supabase generar el UUID para el ID de la entrada automaticamente
            return undefined; 
        }
        
        function showNotification(message, type = 'success', longerDuration = false) { 
            const notification = document.createElement('div'); 
            notification.className = `notification ${type}`; 
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            else if (type === 'error') iconClass = 'fas fa-times-circle';
            else if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';

            notification.innerHTML = `<i class="${iconClass}"></i> ${message}`; 
            document.body.appendChild(notification); 
            setTimeout(() => notification.classList.add('show'), 100); 
            const duration = longerDuration ? 10000 : 5000;
            setTimeout(() => { 
                notification.classList.remove('show'); 
                setTimeout(() => { 
                    if (document.body.contains(notification)) document.body.removeChild(notification); 
                }, 300);
            }, duration);
        }

        function debounce(func, wait) { 
            let timeout; 
            return function executedFunction(...args) { 
                const later = () => { 
                    clearTimeout(timeout); 
                    func(...args); 
                }; 
                clearTimeout(timeout); 
                timeout = setTimeout(later, wait); 
            }; 
        }

        document.addEventListener('keydown', (e) => { 
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) { 
                    case 'n': e.preventDefault(); openAddModal(); break;
                    case 'k': e.preventDefault(); document.getElementById('searchInput').focus(); break;
                    case 'e': e.preventDefault(); openExportModal(); break;
                } 
            } 
            if (e.key === 'Escape') {
                if (document.getElementById('addModal').classList.contains('active')) closeAddModal(); 
                else if (document.getElementById('addUrlModal').classList.contains('active')) closeAddUrlModal(); 
                else if (document.getElementById('viewModal').classList.contains('active')) closeViewModal(); 
                else if (document.getElementById('confirmModal').classList.contains('active')) closeConfirmModal(); 
                else if (document.getElementById('shareModal').classList.contains('active')) closeShareModal(); 
                else if (document.getElementById('updateNotification').classList.contains('show')) closeUpdateNotification(); 
                else if (document.getElementById('mainMenuModal').classList.contains('active')) closeMainMenu(); 
            } 
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registrado', reg))
                    .catch(err => console.error('Error en registro de SW:', err));
            });
        }
        
        const manifest = { 
            name: 'Lunaria Mining Premium', 
            short_name: 'Lunaria Premium', 
            description: 'Gestión avanzada de entradas de mineria', 
            start_url: '.', 
            display: 'standalone', 
            background_color: '#0f172a', 
            theme_color: '#0ea5e9', 
            icons: [
                { src: 'https://i.postimg.cc/GpPsSmmX/4491470.png', sizes: '192x192', type: 'image/png', purpose: 'any maskable' }, 
                { src: 'https://i.postimg.cc/GpPsSmmX/4491470.png', sizes: '512x512', type: 'image/png', purpose: 'any maskable' }
            ], 
            file_handlers: [
                { 
                    action: '.', 
                    accept: { 
                        "application/json": [".json"], 
                        "text/csv": [".csv"] 
                    }, 
                    launch_type: 'single-client', 
                    icons: [{ src: 'https://i.postimg.cc/GpPsSmmX/4491470.png', sizes: '192x192', type: 'image/png' }] 
                }
            ] 
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        document.getElementById('manifest').href = URL.createObjectURL(manifestBlob);

        async function toggleFavorite(id) {
            try {
                const entry = await getEntryById(id); 
                if (!entry) return;

                entry.isFavorite = !entry.isFavorite; // Cambiar el estado
                entry.category = entry.isFavorite ? 'favorites' : (entry.originalCategory || 'other');
                entry.originalCategory = entry.isFavorite ? (entry.originalCategory || entry.category) : undefined;

                await saveEntry(entry);
                await loadEntries();
                updateStats();
                showNotification(entry.isFavorite ? 'Añadido a favoritos' : 'Eliminado de favoritos', 'info');
            } catch (error) {
                console.error('Error al alternar favorito:', error);
                showNotification('Error al cambiar el estado de favorito', 'error');
            }
        }

        async function copyUrlToClipboard(id) {
            try {
                const entry = await getEntryById(id); 
                if (!entry || !entry.url) return showNotification('No hay URL para copiar', 'warning');
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(entry.url).then(() => {
                        showNotification('URL copiada al portapapeles', 'success');
                    }).catch(err => {
                        console.error('Error al copiar URL usando la API del Portapapeles:', err);
                        copyTextToClipboardLegacy(entry.url);
                    });
                } else {
                    copyTextToClipboardLegacy(entry.url);
                }
            } catch (error) {
                console.error('Error al obtener la entrada para copiar:', error);
                showNotification('Error al obtener la URL para copiar', 'error');
            }
        }

        async function confirmInstallIncomingCard(dataToInstall = incomingCardData) {
            if (!dataToInstall) {
                return showNotification('No hay datos de tarjeta para unir', 'error');
            }

            try {
                const result = await integrateSingleCard(dataToInstall); 
                
                if (result === 'added') {
                    showNotification(`Tarjeta "${dataToInstall.name}" unida con Exito`, 'success');
                } else if (result === 'duplicate') {
                    showNotification(`La tarjeta "${dataToInstall.name}" ya existe para ti y no fue agregada.`, 'info');
                }
                
                await loadEntries();
                updateStats();
                updateUsageCharts();
                
                closeInstallCardModal();
            } catch (error) {
                console.error('Error al unir la tarjeta entrante:', error);
                showNotification('Error al unir la tarjeta', 'error');
            }
        }
        function closeInstallCardModal() {
            document.getElementById('installCardModal').classList.remove('active');
            incomingCardData = null;
        }

        async function shareApp() {
            const appUrl = 'https://czuseguridad.github.io/'; // Ajusta esta URL si tu app esta en otro lugar
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Lunaria Mining Premium',
                        text: 'Descubre Lunaria Mining Premium para gestionar tus entradas de mineria!',
                        url: appUrl,
                    });
                    showNotification('Aplicacion compartida con Exito!', 'success');
                } catch (error) {
                    console.error('Error al compartir la aplicacion:', error);
                    showNotification('Error al compartir la aplicacion.', 'error');
                }
            } else {
                copyTextToClipboardLegacy(appUrl);
                showNotification('Enlace de la app copiado al portapapeles. Compartelo!', 'info');
            }
            closeMainMenu();
        }

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    showNotification('Instalación aceptada!', 'success');
                } else {
                    showNotification('Instalación rechazada.', 'warning');
                }
                deferredPrompt = null;
            } else {
                showNotification('La aplicacion ya esta instalada o no se puede instalar en este momento.', 'info', true);
            }
            closeMainMenu();
        }

        // Función para cerrar sesión (interactua con Supabase)
        async function signOutUser() {
            try {
                await supabaseClient.auth.signOut();
                showNotification('Sesión cerrada correctamente. Redirigiendo...', 'success', true);
                setTimeout(() => window.location.href = REDIRECT_LOGIN_URL, 1500);
            } catch (error) {
                console.error('Error al cerrar sesi贸n:', error);
                showNotification(`Error al cerrar sesi贸n: ${error.message}`, 'error', true);
            }
        }
    </script>
</body>
</html>

